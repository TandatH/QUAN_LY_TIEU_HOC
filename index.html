<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School - Quản Lý Điểm & Tài Chính</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 

    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #22c55e;
            --warning: #f59e0b; --danger: #ef4444; --bg-light: #f1f5f9;
            --sidebar-w: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-light); height: 100vh; overflow: hidden; }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .auth-card { background: white; padding: 2.5rem; border-radius: 1rem; width: 420px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); text-align: center; }
        .auth-input { width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; outline: none; }
        .btn-auth { width: 100%; padding: 0.8rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .auth-link { color: var(--primary); font-weight: 600; cursor: pointer; }

        /* LAYOUT */
        #app-container { display: flex; height: 100vh; opacity: 0; transition: opacity 0.5s; }
        .sidebar { width: var(--sidebar-w); background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 1.5rem; font-size: 1.25rem; font-weight: 700; border-bottom: 1px solid #334155; }
        .menu { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .menu-item { padding: 0.75rem 1.5rem; cursor: pointer; color: #94a3b8; display: flex; align-items: center; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: #334155; color: white; border-right: 4px solid var(--primary); }
        .menu-item i { width: 25px; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { background: white; padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .content-area { flex: 1; padding: 2rem; overflow-y: auto; }

        /* UI ELEMENTS */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-top: 5px; }
        .stat-card h3 { font-size: 0.9rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        
        .table-container { background: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        th { background: #f8fafc; font-weight: 600; color: #475569; white-space: nowrap; }
        
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 1rem; padding: 2rem; position: relative; }
        .close-modal { position: absolute; top: 1rem; right: 1rem; cursor: pointer; font-size: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; margin-top: 5px; }

        .hidden { display: none !important; }
        .visible { opacity: 1 !important; }

        /* SPECIFIC STYLES */
        .custom-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; background: white; font-weight: 500; }
        
        /* Finance Styles */
        .money-cell { font-family: 'Courier New', monospace; font-weight: bold; text-align: right; }
        .status-paid { background: #dcfce7; color: #15803d; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; user-select: none; }
        .status-unpaid { background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; user-select: none; border: 1px solid #cbd5e1; }
        .fee-card { border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color: #1e293b; margin-bottom: 5px;">Smart School</h2>
            <p style="color:#64748b; margin-bottom: 2rem;">Hệ thống quản lý điểm</p>
            <div id="form-login">
                <input type="email" id="login-email" class="auth-input" placeholder="Email">
                <input type="password" id="login-pass" class="auth-input" placeholder="Mật khẩu">
                <button class="btn-auth" onclick="handleLogin()">Đăng Nhập</button>
                <div style="margin-top: 1.5rem; font-size: 0.9rem; color: #64748b;">
                    Chưa có tài khoản? <span class="auth-link" onclick="switchAuth('register')">Đăng ký</span>
                </div>
            </div>
            <div id="form-register" class="hidden">
                <input type="email" id="reg-email" class="auth-input" placeholder="Email mới">
                <input type="password" id="reg-pass" class="auth-input" placeholder="Mật khẩu (6+ ký tự)">
                <button class="btn-auth" style="background: var(--success);" onclick="handleRegister()">Đăng Ký</button>
                <div style="margin-top: 1.5rem; font-size: 0.9rem; color: #64748b;">
                    Đã có tài khoản? <span class="auth-link" onclick="switchAuth('login')">Quay lại</span>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-school"></i> SmartSchool</div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('dashboard')"><i class="fas fa-chart-pie"></i> Tổng quan</div>
                <div class="menu-item" onclick="nav('students')"><i class="fas fa-users"></i> Hồ sơ Học sinh</div>
                <div class="menu-item" onclick="nav('academics')"><i class="fas fa-book"></i> Sổ điểm & Môn học</div>
                <div class="menu-item" onclick="nav('finance')"><i class="fas fa-file-invoice-dollar"></i> Tài chính & Thu phí</div>
                <div class="menu-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</div>
            </div>
        </div>

        <div class="main">
            <div class="top-bar">
                <div class="breadcrumb" id="breadcrumb">Trang chủ > <b>Tổng quan</b></div>
                <div id="user-name" style="font-weight:600">User</div>
            </div>

            <div class="content-area">
                
                <div id="view-dashboard" class="view-section">
                    <div class="grid-4">
                        <div class="stat-card"><h3>Tổng Học sinh</h3><div class="value" id="dash-total">0</div></div>
                        <div class="stat-card" style="border-color: #22c55e"><h3>Mới</h3><div class="value" id="dash-new">0</div></div>
                        <div class="stat-card" style="border-color: #f59e0b"><h3>Nam</h3><div class="value" id="dash-male">0</div></div>
                        <div class="stat-card" style="border-color: #ef4444"><h3>Nữ</h3><div class="value" id="dash-female">0</div></div>
                    </div>
                    <div style="background:white; padding:1.5rem; border-radius:0.75rem;">
                        <h4>Thống kê giới tính</h4>
                        <canvas id="genderChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <div id="view-students" class="view-section hidden">
                    <div class="toolbar" style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="search-student" placeholder="Tìm tên/mã HS..." style="padding:8px; border:1px solid #ccc; border-radius:4px">
                            <input type="text" id="filter-class" placeholder="Lọc lớp (VD: 1A)" onkeyup="renderStudentTable()" style="padding:8px; width:120px; border:1px solid #ccc; border-radius:4px">
                        </div>
                        <div style="display:flex; gap:10px;">
                            <label class="btn btn-success"><i class="fas fa-file-excel"></i> Nhập Excel <input type="file" hidden onchange="importExcel(this)"></label>
                            <button class="btn btn-primary" onclick="openModal('modal-student')"><i class="fas fa-plus"></i> Thêm mới</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Mã</th><th>Họ Tên</th><th>Lớp</th><th>Giới tính</th><th>Phụ huynh</th><th>SĐT</th><th>Xóa</th></tr></thead>
                            <tbody id="table-students-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-academics" class="view-section hidden">
                    <div style="background:white; padding:1.5rem; border-radius:0.75rem; margin-bottom: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                            <h3 style="color:var(--primary)"><i class="fas fa-edit"></i> Nhập Điểm Theo Môn</h3>
                            <div style="display:flex; gap:10px">
                                <button class="btn btn-primary" onclick="saveCurrentSubject()"><i class="fas fa-save"></i> Lưu điểm môn này</button>
                                <button class="btn btn-success" onclick="exportMasterExcel()"><i class="fas fa-file-excel"></i> Xuất Báo Cáo (3 Sheet)</button>
                            </div>
                        </div>
                        <div style="background:#f1f5f9; padding:15px; border-radius:8px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                            <div style="display:flex; gap:5px; align-items:center;">
                                <label style="font-weight:600">Lớp:</label>
                                <select id="acad-grade" class="custom-select" style="width: 80px;"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
                                <input type="text" id="acad-class" placeholder="Tên (A,B)" class="custom-select" style="width: 80px;">
                            </div>
                            <div style="display:flex; gap:5px; align-items:center; flex: 1;">
                                <label style="font-weight:600">Môn học:</label>
                                <select id="acad-subject" class="custom-select" style="flex: 1; min-width: 200px; color: var(--primary); font-weight:bold;">
                                    <option value="tiengviet">Tiếng Việt</option>
                                    <option value="toan">Toán</option>
                                    <option value="ngoaingu1">Ngoại ngữ 1</option>
                                    <option value="daoduc">Đạo đức</option>
                                    <option value="tnxh">Tự nhiên và Xã hội</option>
                                    <option value="lsdl">Lịch sử và Địa lý</option>
                                    <option value="khoahoc">Khoa học</option>
                                    <option value="tinhoc">Tin học và Công nghệ</option>
                                    <option value="thechat">Giáo dục Thể chất</option>
                                    <option value="nghethuat">Nghệ thuật</option>
                                    <option value="hdtrainghiem">Hoạt động trải nghiệm</option>
                                </select>
                            </div>
                            <button class="btn btn-warning" onclick="loadClassGrades()" style="color:#1e293b"><i class="fas fa-sync"></i> Tải Bảng Điểm</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="grade-table">
                            <thead>
                                <tr>
                                    <th rowspan="2" style="background:white; vertical-align:middle; width: 200px;">Học sinh</th>
                                    <th colspan="3" class="th-hk1">Học Kỳ 1</th>
                                    <th colspan="3" class="th-hk2">Học Kỳ 2</th>
                                    <th colspan="2" class="th-year">Tổng Kết</th>
                                    <th rowspan="2" style="background:white; vertical-align:middle;">Nhận xét</th>
                                </tr>
                                <tr>
                                    <th style="font-size:0.8rem; text-align:center">Giữa 1</th>
                                    <th style="font-size:0.8rem; text-align:center">Cuối 1</th>
                                    <th style="font-size:0.8rem; text-align:center; color:#0284c7">TB 1</th>
                                    <th style="font-size:0.8rem; text-align:center">Giữa 2</th>
                                    <th style="font-size:0.8rem; text-align:center">Cuối 2</th>
                                    <th style="font-size:0.8rem; text-align:center; color:#16a34a">TB 2</th>
                                    <th style="font-size:0.8rem; text-align:center; color:#ea580c">Cả Năm</th>
                                    <th style="font-size:0.8rem; text-align:center">XL</th>
                                </tr>
                            </thead>
                            <tbody id="table-grades-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-finance" class="view-section hidden">
                    <div class="grid-4">
                        <div class="stat-card" style="border-color: #6366f1">
                            <h3>Tổng Phải Thu</h3>
                            <div class="value" id="fin-total-expect">0 đ</div>
                        </div>
                        <div class="stat-card" style="border-color: #22c55e">
                            <h3>Đã Thu Được</h3>
                            <div class="value" id="fin-total-collected" style="color: #22c55e">0 đ</div>
                        </div>
                        <div class="stat-card" style="border-color: #ef4444">
                            <h3>Chưa Thu</h3>
                            <div class="value" id="fin-total-remain" style="color: #ef4444">0 đ</div>
                        </div>
                        <div class="stat-card" style="border-color: #f59e0b">
                            <h3>Trạng thái</h3>
                            <div class="value" style="font-size: 1rem; font-weight: 500; color: #64748b" id="fin-status-text">Đang xem: Toàn trường</div>
                        </div>
                    </div>

                    <div style="background:white; padding:1.5rem; border-radius:0.75rem; margin-bottom: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                            <h3 style="color:var(--primary)"><i class="fas fa-coins"></i> Quản Lý Khoản Thu</h3>
                            <button class="btn btn-warning" onclick="openModal('modal-fee-settings')"><i class="fas fa-cog"></i> Cài đặt Khoản thu</button>
                        </div>
                        
                        <div style="background:#f1f5f9; padding:15px; border-radius:8px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                            <label style="font-weight:600">Lọc dữ liệu:</label>
                            <select id="fin-filter-grade" class="custom-select" style="width: 100px;">
                                <option value="">Tất cả Khối</option>
                                <option value="1">Khối 1</option>
                                <option value="2">Khối 2</option>
                                <option value="3">Khối 3</option>
                                <option value="4">Khối 4</option>
                                <option value="5">Khối 5</option>
                            </select>
                            <input type="text" id="fin-filter-class" placeholder="Lớp (VD: 1A)" class="custom-select" style="width: 120px;">
                            <button class="btn btn-primary" onclick="loadFinanceView()"><i class="fas fa-filter"></i> Xem Báo Cáo</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="finance-table">
                            <thead id="finance-table-head">
                                </thead>
                            <tbody id="finance-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-student" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('modal-student').style.display='none'">&times;</span>
            <h3>Thêm Học Sinh</h3>
            <div class="form-grid" style="margin-top:1rem">
                <div class="form-group"><label>Họ Tên</label><input type="text" id="inp-name"></div>
                <div class="form-group"><label>Mã HS</label><input type="text" id="inp-code"></div>
                <div class="form-group"><label>Khối</label><select id="inp-grade"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                <div class="form-group"><label>Tên Lớp</label><input type="text" id="inp-classname" placeholder="A, B..."></div>
                <div class="form-group"><label>Giới tính</label><select id="inp-gender"><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div>
                <div class="form-group"><label>Phụ huynh</label><input type="text" id="inp-parent"></div>
                <div class="form-group"><label>SĐT</label><input type="text" id="inp-phone"></div>
            </div>
            <button class="btn btn-primary" style="margin-top:1.5rem; width:100%" onclick="saveStudent()">Lưu</button>
        </div>
    </div>

    <div id="modal-fee-settings" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('modal-fee-settings').style.display='none'">&times;</span>
            <h3>Cài Đặt Các Khoản Thu</h3>
            <p style="color:#64748b; font-size:0.9rem; margin-bottom:1rem">Thiết lập các khoản cần thu cho năm học này.</p>
            
            <div style="display:flex; gap:10px; margin-bottom:1rem; border-bottom:1px solid #e2e8f0; padding-bottom:1rem;">
                <input type="text" id="new-fee-name" placeholder="Tên khoản thu (VD: Quỹ lớp)" class="custom-select" style="flex:1">
                <input type="number" id="new-fee-amount" placeholder="Số tiền (VNĐ)" class="custom-select" style="width:150px">
                <button class="btn btn-success" onclick="addNewFeeType()"><i class="fas fa-plus"></i> Thêm</button>
            </div>

            <div id="fee-list-container" style="max-height:300px; overflow-y:auto;">
                </div>
            <button class="btn btn-primary" style="margin-top:1rem; width:100%" onclick="document.getElementById('modal-fee-settings').style.display='none'; loadFinanceView()">Đóng & Cập nhật</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, get, child, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBXeGmjCH_v6jnxEmBoQMpY7NP2fqrnLAQ",
            authDomain: "quan-ly-tieu-hoc.firebaseapp.com",
            databaseURL: "https://quan-ly-tieu-hoc-default-rtdb.firebaseio.com",
            projectId: "quan-ly-tieu-hoc",
            storageBucket: "quan-ly-tieu-hoc.firebasestorage.app",
            messagingSenderId: "525298263647",
            appId: "1:525298263647:web:767a5df6ac373323671dea"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let studentsLocal = {};
        let feeConfigLocal = {};
        let feeStatusLocal = {};

        // --- AUTH ---
        window.switchAuth = (m) => {
            document.getElementById('form-login').classList.toggle('hidden', m==='register');
            document.getElementById('form-register').classList.toggle('hidden', m!=='register');
        }
        window.handleLogin = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); }
            catch(e) { Swal.fire('Lỗi', 'Email hoặc mật khẩu sai', 'error'); }
        }
        window.handleRegister = async () => {
            try { await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-pass').value); Swal.fire('Thành công','Đăng nhập ngay...','success'); }
            catch(e) { Swal.fire('Lỗi', e.message, 'error'); }
        }
        window.handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            document.getElementById('auth-screen').style.display = user ? 'none' : 'flex';
            document.getElementById('app-container').classList.toggle('visible', !!user);
            document.getElementById('app-container').classList.toggle('hidden', !user);
            if(user) { document.getElementById('user-name').innerText = user.email; initData(); }
        });

        // --- DATA INIT ---
        function initData() {
            // Load Students
            onValue(ref(db, 'students'), (snap) => {
                studentsLocal = snap.val() || {};
                renderStudentTable();
                updateDashboard();
                if(!document.getElementById('view-finance').classList.contains('hidden')) loadFinanceView();
            });
            // Load Fee Config
            onValue(ref(db, 'finance_config'), (snap) => {
                feeConfigLocal = snap.val() || {};
                renderFeeSettingsList();
            });
            // Load Fee Status
            onValue(ref(db, 'finance_status'), (snap) => {
                feeStatusLocal = snap.val() || {};
                if(!document.getElementById('view-finance').classList.contains('hidden')) loadFinanceView();
            });
        }

        window.nav = (tab) => {
            document.querySelectorAll('.view-section').forEach(el=>el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.menu-item').forEach(el=>el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(tab === 'finance') loadFinanceView();
        }
        window.openModal = (id) => document.getElementById(id).style.display='flex';

        // --- STUDENTS LOGIC ---
        window.renderStudentTable = () => {
            const tbody = document.getElementById('table-students-body'); tbody.innerHTML = '';
            const search = document.getElementById('search-student').value.toLowerCase();
            const fClass = document.getElementById('filter-class').value.toUpperCase();
            Object.entries(studentsLocal).forEach(([key, s]) => {
                if(fClass && !s.class.includes(fClass)) return;
                if(search && !s.name.toLowerCase().includes(search)) return;
                tbody.innerHTML += `<tr><td><b>${s.code}</b></td><td>${s.name}</td><td><span style="background:#dbeafe;color:#1e40af;padding:2px 6px;border-radius:4px">${s.class}</span></td><td>${s.gender}</td><td>${s.parent||''}</td><td>${s.phone||''}</td><td><button onclick="delStudent('${key}')" style="color:red;border:none;background:none"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        window.saveStudent = () => {
            const c = document.getElementById('inp-grade').value + document.getElementById('inp-classname').value.toUpperCase();
            if(c.length<2) return Swal.fire('Thiếu lớp','','warning');
            push(ref(db, 'students'), {
                name: document.getElementById('inp-name').value, code: document.getElementById('inp-code').value||'HS'+Date.now().toString().slice(-4),
                class: c, gender: document.getElementById('inp-gender').value, parent: document.getElementById('inp-parent').value, phone: document.getElementById('inp-phone').value, createdAt: Date.now()
            }).then(()=>{ document.getElementById('modal-student').style.display='none'; Swal.fire('Thêm xong','','success'); });
        }
        window.delStudent = (k) => { if(confirm('Xóa?')) remove(ref(db, `students/${k}`)); }

        // --- FINANCE LOGIC (NEW) ---

        // 1. Quản lý Loại phí (Settings)
        window.addNewFeeType = () => {
            const name = document.getElementById('new-fee-name').value;
            const amount = document.getElementById('new-fee-amount').value;
            if(!name || !amount) return Swal.fire('Lỗi','Vui lòng nhập tên và số tiền','warning');
            
            push(ref(db, 'finance_config'), { name: name, amount: parseInt(amount) });
            document.getElementById('new-fee-name').value = '';
            document.getElementById('new-fee-amount').value = '';
        }

        window.deleteFeeType = (key) => {
            if(confirm('Xóa khoản thu này? Dữ liệu thu tiền cũ vẫn được giữ nhưng không hiển thị cột này nữa.')) {
                remove(ref(db, `finance_config/${key}`));
            }
        }

        function renderFeeSettingsList() {
            const container = document.getElementById('fee-list-container');
            container.innerHTML = '';
            Object.entries(feeConfigLocal).forEach(([key, fee]) => {
                container.innerHTML += `
                    <div class="fee-card">
                        <div>
                            <div style="font-weight:bold; color:#1e293b">${fee.name}</div>
                            <div style="font-size:0.9rem; color:#64748b">${parseInt(fee.amount).toLocaleString('vi-VN')} đ</div>
                        </div>
                        <button onclick="deleteFeeType('${key}')" class="btn btn-danger" style="padding:4px 8px; font-size:0.8rem"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }

        // 2. Hiển thị & Xử lý Tài chính
        window.loadFinanceView = () => {
            const filterGrade = document.getElementById('fin-filter-grade').value;
            const filterClass = document.getElementById('fin-filter-class').value.toUpperCase().trim();
            const searchStatus = document.getElementById('fin-status-text');

            let filteredStudents = Object.entries(studentsLocal);
            let contextName = "Toàn trường";

            if (filterGrade || filterClass) {
                filteredStudents = filteredStudents.filter(([k, s]) => {
                    let match = true;
                    if (filterGrade && !s.class.startsWith(filterGrade)) match = false;
                    if (filterClass && s.class !== filterClass) match = false;
                    return match;
                });
                
                if (filterClass) contextName = `Lớp ${filterClass}`;
                else if (filterGrade) contextName = `Khối ${filterGrade}`;
            }
            searchStatus.innerText = `Đang xem: ${contextName}`;

            // Render Headers
            const thead = document.getElementById('finance-table-head');
            const tbody = document.getElementById('finance-table-body');
            thead.innerHTML = ''; tbody.innerHTML = '';

            // Header Row
            let headerHTML = `<tr><th style="width:200px">Học sinh / Lớp</th>`;
            const feeKeys = Object.keys(feeConfigLocal);
            feeKeys.forEach(k => {
                headerHTML += `<th style="text-align:center">${feeConfigLocal[k].name}<br><small style="color:#64748b; font-weight:normal">${parseInt(feeConfigLocal[k].amount).toLocaleString()}đ</small></th>`;
            });
            headerHTML += `<th style="text-align:right">Đã nộp</th></tr>`;
            thead.innerHTML = headerHTML;

            // Stats Variables
            let totalExpected = 0;
            let totalCollected = 0;

            // Render Rows
            if (filteredStudents.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${feeKeys.length + 2}" style="text-align:center; padding:2rem;">Không tìm thấy học sinh nào.</td></tr>`;
                updateFinanceStats(0, 0);
                return;
            }

            filteredStudents.forEach(([stuKey, student]) => {
                let rowHTML = `<tr><td><b>${student.name}</b><br><small style="color:#64748b">${student.class}</small></td>`;
                let studentTotalPaid = 0;
                
                feeKeys.forEach(feeKey => {
                    const feeAmount = parseInt(feeConfigLocal[feeKey].amount);
                    totalExpected += feeAmount; // Cộng vào tổng dự kiến
                    
                    // Check status
                    const isPaid = feeStatusLocal[stuKey] && feeStatusLocal[stuKey][feeKey] === true;
                    if (isPaid) {
                        totalCollected += feeAmount;
                        studentTotalPaid += feeAmount;
                        rowHTML += `<td style="text-align:center"><span class="status-paid" onclick="toggleFee('${stuKey}', '${feeKey}', false)">Đã thu <i class="fas fa-check"></i></span></td>`;
                    } else {
                        rowHTML += `<td style="text-align:center"><span class="status-unpaid" onclick="toggleFee('${stuKey}', '${feeKey}', true)">Chưa thu</span></td>`;
                    }
                });

                rowHTML += `<td class="money-cell" style="color:#15803d">${studentTotalPaid.toLocaleString()}</td></tr>`;
                tbody.innerHTML += rowHTML;
            });

            updateFinanceStats(totalExpected, totalCollected);
        }

        window.toggleFee = (stuKey, feeKey, newVal) => {
            // Update Firebase directly
            update(ref(db, `finance_status/${stuKey}`), { [feeKey]: newVal });
            // UI will auto-update because of onValue listener
        }

        function updateFinanceStats(expected, collected) {
            document.getElementById('fin-total-expect').innerText = expected.toLocaleString('vi-VN') + ' đ';
            document.getElementById('fin-total-collected').innerText = collected.toLocaleString('vi-VN') + ' đ';
            document.getElementById('fin-total-remain').innerText = (expected - collected).toLocaleString('vi-VN') + ' đ';
        }

        // --- ACADEMIC LOGIC (OLD) ---
        // (Giữ nguyên logic cũ cho phần nhập điểm)
        const SUBJECTS_MAP = { 'tiengviet':'Tiếng Việt', 'toan':'Toán', 'ngoaingu1':'Ngoại ngữ 1', 'daoduc':'Đạo đức', 'tnxh':'TN & XH', 'lsdl':'Lịch sử & ĐL', 'khoahoc':'Khoa học', 'tinhoc':'Tin học & CN', 'thechat':'GD Thể chất', 'nghethuat':'Nghệ thuật', 'hdtrainghiem':'HĐ Trải nghiệm' };
        
        window.loadClassGrades = async () => {
            const fullClass = document.getElementById('acad-grade').value + document.getElementById('acad-class').value.toUpperCase().trim();
            const subjectId = document.getElementById('acad-subject').value;
            if(fullClass.length<2) return Swal.fire('Lỗi','Nhập tên lớp','warning');
            let grades = {}; try{const s=await get(child(ref(db),`grades/${fullClass}/${subjectId}`));if(s.exists())grades=s.val();}catch(e){}
            const stus = Object.entries(studentsLocal).filter(([k,s])=>s.class===fullClass);
            const tb = document.getElementById('table-grades-body'); tb.innerHTML='';
            if(stus.length===0){ tb.innerHTML='<tr><td colspan="10" style="text-align:center">Chưa có HS</td></tr>'; return;}
            stus.forEach(([k,s])=>{
                const g = grades[k]||{};
                tb.innerHTML+=`<tr data-id="${k}"><td><b>${s.name}</b></td><td class="tc"><input class="inp-mini gk1" value="${g.gk1||''}" oninput="calcRow(this)"></td><td class="tc"><input class="inp-mini ck1" value="${g.ck1||''}" oninput="calcRow(this)"></td><td class="col-calc tb1">-</td><td class="tc"><input class="inp-mini gk2" value="${g.gk2||''}" oninput="calcRow(this)"></td><td class="tc"><input class="inp-mini ck2" value="${g.ck2||''}" oninput="calcRow(this)"></td><td class="col-calc tb2">-</td><td class="col-calc year">-</td><td class="col-calc rank" style="font-weight:normal">-</td><td><input class="inp-nx" value="${g.nx||''}" style="width:100%"></td></tr>`;
            });
            document.querySelectorAll('#table-grades-body tr').forEach(r=>calcRow(r.querySelector('input')));
        }
        window.calcRow = (el)=>{
            if(!el)return; const tr=el.closest('tr');
            const v=(s)=>{const x=tr.querySelector(s).value;return x===''?null:parseFloat(x)};
            const t1=(v('.gk1')!==null&&v('.ck1')!==null)?(v('.gk1')+v('.ck1')*2)/3:null;
            const t2=(v('.gk2')!==null&&v('.ck2')!==null)?(v('.gk2')+v('.ck2')*2)/3:null;
            tr.querySelector('.tb1').innerText=t1!==null?t1.toFixed(1):'-';
            tr.querySelector('.tb2').innerText=t2!==null?t2.toFixed(1):'-';
            if(t1!==null&&t2!==null){const cn=(t1+t2*2)/3;tr.querySelector('.year').innerText=cn.toFixed(1);tr.querySelector('.rank').innerText=cn>=9?'HTT':cn>=7?'Tốt':cn>=5?'HT':'CHT';}
        }
        window.saveCurrentSubject = async () => {
             const cls = document.getElementById('acad-grade').value + document.getElementById('acad-class').value.toUpperCase().trim();
             const subj = document.getElementById('acad-subject').value;
             const rows = document.querySelectorAll('#table-grades-body tr');
             const u = {}; rows.forEach(r=>{ const id=r.getAttribute('data-id'); u[id]={gk1:r.querySelector('.gk1').value,ck1:r.querySelector('.ck1').value,gk2:r.querySelector('.gk2').value,ck2:r.querySelector('.ck2').value,nx:r.querySelector('.inp-nx').value};});
             await set(ref(db,`grades/${cls}/${subj}`), u); Swal.fire('Đã lưu','','success');
        }
        window.exportMasterExcel = async () => { /* Giữ nguyên hàm export 3 sheet ở câu trả lời trước */ 
            const cls = document.getElementById('acad-grade').value + document.getElementById('acad-class').value.toUpperCase().trim();
            if(cls.length < 2) return Swal.fire('Lỗi', 'Chưa chọn lớp', 'warning');
            Swal.showLoading();
            const students = Object.values(studentsLocal).filter(s => s.class === cls);
            let allGrades = {}; try { const snap = await get(child(ref(db), `grades/${cls}`)); if(snap.exists()) allGrades = snap.val(); } catch(e) {}
            const ds1=[], ds2=[], dscn=[];
            students.forEach(s => {
                const k = Object.keys(studentsLocal).find(x=>studentsLocal[x].code===s.code);
                let r1={'Mã':s.code,'Tên':s.name}, r2={'Mã':s.code,'Tên':s.name}, rcn={'Mã':s.code,'Tên':s.name}, nx=[];
                Object.entries(SUBJECTS_MAP).forEach(([id,name])=>{
                    const g=allGrades[id]&&allGrades[id][k]?allGrades[id][k]:{};
                    const t1=(g.gk1&&g.ck1)?((parseFloat(g.gk1)+parseFloat(g.ck1)*2)/3):null;
                    const t2=(g.gk2&&g.ck2)?((parseFloat(g.gk2)+parseFloat(g.ck2)*2)/3):null;
                    const cn=(t1&&t2)?((t1+t2*2)/3):null;
                    r1[name]=t1?t1.toFixed(1):''; r2[name]=t2?t2.toFixed(1):''; rcn[name]=cn?cn.toFixed(1):'';
                    if(g.nx) nx.push(`[${name}]: ${g.nx}`);
                });
                r1['NX']=nx.join('; '); r2['NX']=nx.join('; '); rcn['NX']=nx.join('; ');
                ds1.push(r1); ds2.push(r2); dscn.push(rcn);
            });
            const wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(ds1),"HK1");
            XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(ds2),"HK2");
            XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dscn),"CaNam");
            XLSX.writeFile(wb, `BaoCao_${cls}.xlsx`); Swal.close();
        }

        // Dashboard Stats
        function updateDashboard(){
            const arr = Object.values(studentsLocal);
            document.getElementById('dash-total').innerText = arr.length;
            document.getElementById('dash-new').innerText = arr.filter(s=>(Date.now()-s.createdAt)<2592000000).length;
            const nam = arr.filter(s=>s.gender==='Nam').length, nu = arr.filter(s=>s.gender==='Nữ').length;
            document.getElementById('dash-male').innerText = nam; document.getElementById('dash-female').innerText = nu;
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(document.getElementById('genderChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Nam', 'Nữ'], datasets: [{ data: [nam, nu], backgroundColor: ['#3b82f6', '#ec4899'] }] } });
        }
    </script>
    <style>.tc{text-align:center}</style>
</body>
</html>
