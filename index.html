<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School Pro - H·ªá Th·ªëng Qu·∫£n L√Ω Gi√°o D·ª•c</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #16a34a;
            --warning: #d97706; --danger: #dc2626; --bg-light: #f1f5f9;
            --sidebar-w: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-light); height: 100vh; overflow: hidden; font-size: 14px; }

        /* --- LAYOUT --- */
        #app-container { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-w); background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 1.5rem; font-size: 1.3rem; font-weight: 700; border-bottom: 1px solid #334155; display:flex; align-items:center; gap:10px; }
        .menu { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .menu-item { padding: 0.8rem 1.5rem; cursor: pointer; color: #94a3b8; display: flex; align-items: center; transition: 0.2s; gap: 12px; }
        .menu-item:hover, .menu-item.active { background: #334155; color: white; border-right: 4px solid var(--primary); }
        
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f8fafc; }
        .top-bar { background: white; padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .content-area { flex: 1; padding: 20px; overflow-y: auto; }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3a8a, #2563eb); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .auth-card { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); text-align: center; }
        .auth-inp { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; }
        .btn-auth { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-auth:hover { opacity: 0.9; }
        .hidden { display: none !important; }

        /* --- UI COMPONENTS --- */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; font-weight: 500; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-top: 5px; }

        /* TABLE */
        .table-wrapper { background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f1f5f9; text-align: left; padding: 12px 16px; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; text-transform: uppercase; white-space: nowrap; }
        td { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        
        .avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #e2e8f0; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; border-radius: 12px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 25px; overflow-y: auto; }
        
        .form-section { margin-bottom: 25px; }
        .form-section h4 { color: var(--primary); margin-bottom: 15px; font-size: 1rem; border-left: 4px solid var(--primary); padding-left: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #64748b; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .custom-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; background: white; }
        
        .score-input { width: 60px; text-align: center; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; }
        .score-input:focus { border-color: var(--primary); outline: none; }

        @media (max-width: 768px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color:#1e293b; margin-bottom:5px"><i class="fas fa-school"></i> Smart School</h2>
            <p style="color:#64748b; margin-bottom:20px">H·ªá th·ªëng qu·∫£n l√Ω gi√°o d·ª•c</p>

            <div id="form-login">
                <h3 style="margin-bottom:15px; color:var(--primary)">ƒêƒÉng Nh·∫≠p</h3>
                <input type="email" id="login-email" class="auth-inp" placeholder="Email">
                <input type="password" id="login-pass" class="auth-inp" placeholder="M·∫≠t kh·∫©u">
                <button class="btn-auth" onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button>
                <div style="margin-top:15px; font-size:0.9rem;">
                    Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" style="color:var(--primary); font-weight:600" onclick="toggleAuthMode('register'); return false;">ƒêƒÉng k√Ω ngay</a>
                </div>
            </div>

            <div id="form-register" class="hidden">
                <h3 style="margin-bottom:15px; color:var(--success)">ƒêƒÉng K√Ω M·ªõi</h3>
                <input type="email" id="reg-email" class="auth-inp" placeholder="Email ƒëƒÉng k√Ω">
                <input type="password" id="reg-pass" class="auth-inp" placeholder="M·∫≠t kh·∫©u (min 6 k√Ω t·ª±)">
                
                <select id="reg-role" class="auth-inp" onchange="toggleRegFields()">
                    <option value="" disabled selected>-- Ch·ªçn vai tr√≤ --</option>
                    <option value="parent">Ph·ª• huynh</option>
                    <option value="teacher">Gi√°o vi√™n</option>
                    <option value="admin">Qu·∫£n tr·ªã vi√™n (Admin)</option>
                </select>

                <div id="reg-extra-fields">
                    <input type="text" id="reg-class" class="auth-inp hidden" placeholder="L·ªõp ph·ª• tr√°ch (VD: 1A)">
                    <input type="text" id="reg-student-id" class="auth-inp hidden" placeholder="M√£ h·ªçc sinh c·ªßa con (VD: HS123)">
                </div>

                <button class="btn-auth" style="background:var(--success)" onclick="handleRegister()">T·∫°o T√†i Kho·∫£n</button>
                <div style="margin-top:15px; font-size:0.9rem;">
                    ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" style="color:var(--primary); font-weight:600" onclick="toggleAuthMode('login'); return false;">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-graduation-cap"></i> Smart School</div>
            <nav class="menu" id="main-menu">
                <!-- Dynamic menu based on role -->
            </nav>
            <div style="padding:1rem; border-top:1px solid #334155">
                <button class="btn btn-danger" style="width:100%" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </aside>

        <main class="main">
            <div class="top-bar">
                <h2 id="page-title">Dashboard</h2>
                <div style="display:flex; align-items:center; gap:15px">
                    <span id="user-info"></span>
                </div>
            </div>

            <div class="content-area" id="content">
                <!-- Dynamic content -->
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="modal-student" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> <span id="modal-student-title">Th√™m H·ªçc Sinh</span></h3>
                <button class="btn btn-outline" onclick="closeModal('modal-student')">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="student-form" onsubmit="saveStudent(event)">
                    <div class="form-section">
                        <h4>Th√¥ng tin c∆° b·∫£n</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>M√£ h·ªçc sinh *</label>
                                <input type="text" name="code" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>H·ªç v√† t√™n *</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>L·ªõp *</label>
                                <input type="text" name="classRoom" class="form-control" placeholder="VD: 1A, 2B" required>
                            </div>
                            <div class="form-group">
                                <label>Gi·ªõi t√≠nh</label>
                                <select name="gender" class="form-control">
                                    <option value="Nam">Nam</option>
                                    <option value="N·ªØ">N·ªØ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ng√†y sinh</label>
                                <input type="date" name="dob" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>SƒêT Kh·∫©n c·∫•p</label>
                                <input type="tel" name="sosPhone" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Th√¥ng tin Ph·ª• huynh</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>H·ªç t√™n Cha</label>
                                <input type="text" name="dadName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>SƒêT Cha</label>
                                <input type="tel" name="dadPhone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>H·ªç t√™n M·∫π</label>
                                <input type="text" name="momName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>SƒêT M·∫π</label>
                                <input type="tel" name="momPhone" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div style="text-align:right; margin-top:20px">
                        <button type="button" class="btn btn-outline" onclick="closeModal('modal-student')">H·ªßy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-finance" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> <span id="modal-finance-title">Th√™m Kho·∫£n Thu/Chi</span></h3>
                <button class="btn btn-outline" onclick="closeModal('modal-finance')">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="finance-form" onsubmit="saveFinance(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Lo·∫°i giao d·ªãch *</label>
                            <select name="type" class="form-control" required onchange="toggleFinanceCategory()">
                                <option value="income">Thu</option>
                                <option value="expense">Chi</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Danh m·ª•c *</label>
                            <select name="category" class="form-control" required id="finance-category">
                                <optgroup label="Thu">
                                    <option value="tuition">H·ªçc ph√≠</option>
                                    <option value="exam_fee">Ph√≠ thi</option>
                                    <option value="uniform">ƒê·ªìng ph·ª•c</option>
                                    <option value="meal">Ti·ªÅn ƒÉn</option>
                                    <option value="other_income">Thu kh√°c</option>
                                </optgroup>
                                <optgroup label="Chi">
                                    <option value="salary">L∆∞∆°ng</option>
                                    <option value="utility">ƒêi·ªán n∆∞·ªõc</option>
                                    <option value="maintenance">B·∫£o tr√¨</option>
                                    <option value="supplies">VƒÉn ph√≤ng ph·∫©m</option>
                                    <option value="other_expense">Chi kh√°c</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>S·ªë ti·ªÅn (VNƒê) *</label>
                            <input type="number" name="amount" class="form-control" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Ng√†y giao d·ªãch *</label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>M√£ h·ªçc sinh (n·∫øu c√≥)</label>
                            <input type="text" name="studentCode" class="form-control" placeholder="VD: HS001">
                        </div>
                        <div class="form-group">
                            <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                            <select name="paymentMethod" class="form-control">
                                <option value="cash">Ti·ªÅn m·∫∑t</option>
                                <option value="bank">Chuy·ªÉn kho·∫£n</option>
                                <option value="card">Th·∫ª</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="custom-income-field" style="display:none">
                        <label>N·ªôi dung thu *</label>
                        <input type="text" name="customIncome" class="form-control" placeholder="Nh·∫≠p n·ªôi dung kho·∫£n thu">
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea name="note" class="form-control" rows="3"></textarea>
                    </div>
                    <div style="text-align:right; margin-top:20px">
                        <button type="button" class="btn btn-outline" onclick="closeModal('modal-finance')">H·ªßy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-score" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Nh·∫≠p ƒêi·ªÉm - <span id="score-student-name"></span></h3>
                <button class="btn btn-outline" onclick="closeModal('modal-score')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:20px">
                    <label style="font-weight:600; margin-right:10px">Ch·ªçn H·ªçc k·ª≥:</label>
                    <select id="score-semester" class="custom-select" onchange="loadScoreForm()">
                        <option value="1">H·ªçc k·ª≥ 1</option>
                        <option value="2">H·ªçc k·ª≥ 2</option>
                    </select>
                </div>
                <div id="score-form-container"></div>
                <div style="text-align:right; margin-top:20px">
                    <button class="btn btn-outline" onclick="closeModal('modal-score')">H·ªßy</button>
                    <button class="btn btn-success" onclick="saveScores()">
                        <i class="fas fa-save"></i> L∆∞u ƒëi·ªÉm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase & App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, onValue, push, remove } 
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getFunctions, httpsCallable } 
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBXeGmjCH_v6jnxEmBoQMpY7NP2fqrnLAQ",
            authDomain: "quan-ly-tieu-hoc.firebaseapp.com",
            databaseURL: "https://quan-ly-tieu-hoc-default-rtdb.firebaseio.com",
            projectId: "quan-ly-tieu-hoc",
            storageBucket: "quan-ly-tieu-hoc.firebasestorage.app",
            messagingSenderId: "525298263647",
            appId: "1:525298263647:web:767a5df6ac373323671dea"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const functions = getFunctions(app);

        // Global vars
        window.auth = auth;
        window.db = db;
        window.currentUser = null;
        window.userRole = null;
        window.teacherClass = null;
        window.localData = { students: {}, scores: {}, finance: {} };
        window.editingStudentId = null;
        window.currentScoreStudent = null;

        // Subjects for Primary School (CT 2018)
        window.PRIMARY_SUBJECTS = {
            '1': ['Ti·∫øng Vi·ªát', 'To√°n', 'ƒê·∫°o ƒë·ª©c', 'T·ª± nhi√™n v√† X√£ h·ªôi', '√Çm nh·∫°c', 'M·ªπ thu·∫≠t', 'Th·ªÉ d·ª•c', 'Ho·∫°t ƒë·ªông tr·∫£i nghi·ªám'],
            '2': ['Ti·∫øng Vi·ªát', 'To√°n', 'ƒê·∫°o ƒë·ª©c', 'T·ª± nhi√™n v√† X√£ h·ªôi', '√Çm nh·∫°c', 'M·ªπ thu·∫≠t', 'Th·ªÉ d·ª•c', 'Ho·∫°t ƒë·ªông tr·∫£i nghi·ªám'],
            '3': ['Ti·∫øng Vi·ªát', 'To√°n', 'ƒê·∫°o ƒë·ª©c', 'T·ª± nhi√™n v√† X√£ h·ªôi', '√Çm nh·∫°c', 'M·ªπ thu·∫≠t', 'Th·ªÉ d·ª•c', 'Ho·∫°t ƒë·ªông tr·∫£i nghi·ªám', 'Ti·∫øng Anh'],
            '4': ['Ti·∫øng Vi·ªát', 'To√°n', 'ƒê·∫°o ƒë·ª©c', 'Khoa h·ªçc', 'L·ªãch s·ª≠ v√† ƒê·ªãa l√Ω', '√Çm nh·∫°c', 'M·ªπ thu·∫≠t', 'Th·ªÉ d·ª•c', 'Ho·∫°t ƒë·ªông tr·∫£i nghi·ªám', 'Ti·∫øng Anh', 'Tin h·ªçc'],
            '5': ['Ti·∫øng Vi·ªát', 'To√°n', 'ƒê·∫°o ƒë·ª©c', 'Khoa h·ªçc', 'L·ªãch s·ª≠ v√† ƒê·ªãa l√Ω', '√Çm nh·∫°c', 'M·ªπ thu·∫≠t', 'Th·ªÉ d·ª•c', 'Ho·∫°t ƒë·ªông tr·∫£i nghi·ªám', 'Ti·∫øng Anh', 'Tin h·ªçc']
        };

        // Auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await get(child(ref(db), `users/${user.uid}`));
                if (snap.exists()) {
                    window.currentUser = user;
                    const userData = snap.val();
                    window.userRole = userData.role;
                    window.teacherClass = userData.assignedClass;
                    
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('user-info').textContent = `${userData.email} (${userData.role})`;
                    
                    loadMenu();
                    loadData();
                    changeView('dashboard');
                }
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        // Load menu based on role
        function loadMenu() {
            const menuItems = {
                'admin': [
                    { id: 'dashboard', icon: 'chart-line', text: 'Dashboard' },
                    { id: 'students', icon: 'user-graduate', text: 'Qu·∫£n l√Ω H·ªçc sinh' },
                    { id: 'attendance', icon: 'clipboard-check', text: 'ƒêi·ªÉm danh' },
                    { id: 'scores', icon: 'star', text: 'Qu·∫£n l√Ω ƒêi·ªÉm' },
                    { id: 'finance', icon: 'dollar-sign', text: 'Qu·∫£n l√Ω T√†i ch√≠nh' },
                    { id: 'users', icon: 'users-cog', text: 'Qu·∫£n l√Ω Users' }
                ],
                'teacher': [
                    { id: 'dashboard', icon: 'chart-line', text: 'Dashboard' },
                    { id: 'students', icon: 'user-graduate', text: 'H·ªçc sinh l·ªõp m√¨nh' },
                    { id: 'attendance', icon: 'clipboard-check', text: 'ƒêi·ªÉm danh' },
                    { id: 'scores', icon: 'star', text: 'Qu·∫£n l√Ω ƒêi·ªÉm' },
                    { id: 'finance', icon: 'dollar-sign', text: 'Danh s√°ch ƒë√≥ng ti·ªÅn' }
                ],
                'parent': [
                    { id: 'dashboard', icon: 'chart-line', text: 'Dashboard' },
                    { id: 'child-info', icon: 'user', text: 'Th√¥ng tin con' }
                ]
            };

            const items = menuItems[window.userRole] || menuItems['parent'];
            let html = '';
            items.forEach(item => {
                html += `<div class="menu-item" onclick="changeView('${item.id}')">
                    <i class="fas fa-${item.icon}"></i> ${item.text}
                </div>`;
            });
            document.getElementById('main-menu').innerHTML = html;
        }

        // Load data
        function loadData() {
            onValue(ref(db, 'students'), snap => {
                window.localData.students = snap.val() || {};
                const view = document.getElementById('content').dataset.view;
                if (view === 'students') renderStudents();
                else if (view === 'scores') renderScores();
            });
            onValue(ref(db, 'scores'), snap => {
                window.localData.scores = snap.val() || {};
            });
            onValue(ref(db, 'finance'), snap => {
                window.localData.finance = snap.val() || {};
                if (document.getElementById('content').dataset.view === 'finance') {
                    renderFinance();
                }
            });
        }

        // AUTH FUNCTIONS
        window.toggleAuthMode = (mode) => {
            if (mode === 'register') {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-register').classList.remove('hidden');
            } else {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-register').classList.add('hidden');
            }
        }

        window.toggleRegFields = () => {
            const role = document.getElementById('reg-role').value;
            document.getElementById('reg-class').classList.toggle('hidden', role !== 'teacher');
            document.getElementById('reg-student-id').classList.toggle('hidden', role !== 'parent');
        }

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            
            if (!email || !pass) {
                Swal.fire('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                Swal.fire('Th√†nh c√¥ng', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
            } catch (error) {
                Swal.fire('L·ªói', 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng', 'error');
            }
        }

        window.handleRegister = async () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const role = document.getElementById('reg-role').value;
            
            if (!email || !pass || !role) {
                Swal.fire('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                return;
            }
            
            if (pass.length < 6) {
                Swal.fire('L·ªói', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
                return;
            }

            try {
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                const userData = {
                    email: email,
                    role: role,
                    createdAt: Date.now()
                };
                
                if (role === 'teacher') {
                    userData.assignedClass = document.getElementById('reg-class').value;
                } else if (role === 'parent') {
                    userData.studentId = document.getElementById('reg-student-id').value;
                }
                
                await set(ref(db, `users/${userCred.user.uid}`), userData);
                
                // Sign out immediately after registration
                await signOut(auth);
                
                // Reset form and switch to login
                document.getElementById('form-register').classList.add('hidden');
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-pass').value = '';
                document.getElementById('reg-role').value = '';
                
                Swal.fire({
                    icon: 'success',
                    title: 'T·∫°o t√†i kho·∫£n th√†nh c√¥ng!',
                    text: 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng h·ªá th·ªëng.',
                    confirmButtonText: 'OK'
                });
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    Swal.fire('L·ªói', 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng', 'error');
                } else {
                    Swal.fire('L·ªói', error.message, 'error');
                }
            }
        }

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                Swal.fire('ƒê√£ ƒëƒÉng xu·∫•t', 'H·∫πn g·∫∑p l·∫°i!', 'success');
            } catch (error) {
                Swal.fire('L·ªói', error.message, 'error');
            }
        }

        // VIEW MANAGEMENT
        window.changeView = (view) => {
            document.querySelectorAll('.menu-item').forEach(x => x.classList.remove('active'));
            if (event && event.target) {
                event.target.closest('.menu-item').classList.add('active');
            }
            
            document.getElementById('content').dataset.view = view;
            
            const titles = {
                'dashboard': 'Dashboard',
                'students': window.userRole === 'teacher' ? 'H·ªçc sinh l·ªõp m√¨nh' : 'Qu·∫£n l√Ω H·ªçc sinh',
                'attendance': 'ƒêi·ªÉm danh',
                'scores': 'Qu·∫£n l√Ω ƒêi·ªÉm',
                'finance': window.userRole === 'teacher' ? 'Danh s√°ch ƒë√≥ng ti·ªÅn' : 'Qu·∫£n l√Ω T√†i ch√≠nh',
                'users': 'Qu·∫£n l√Ω Users',
                'child-info': 'Th√¥ng tin con'
            };
            
            document.getElementById('page-title').textContent = titles[view] || 'Dashboard';
            
            if (view === 'dashboard') renderDashboard();
            else if (view === 'students') renderStudents();
            else if (view === 'attendance') renderAttendance();
            else if (view === 'scores') renderScores();
            else if (view === 'finance') renderFinance();
            else if (view === 'users') renderUsers();
        }

        // DASHBOARD
        function renderDashboard() {
            let students = Object.values(window.localData.students);
            
            // Filter for teacher - only their class
            if (window.userRole === 'teacher' && window.teacherClass) {
                students = students.filter(s => s.classRoom === window.teacherClass || s.class === window.teacherClass);
            }
            
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'active').length;
            const classes = [...new Set(students.map(s => s.classRoom || s.class))].length;
            
            document.getElementById('content').innerHTML = `
                <div class="grid-4">
                    <div class="stat-card" style="border-left-color: var(--primary)">
                        <div style="color:#64748b">${window.userRole === 'teacher' ? 'H·ªçc sinh l·ªõp m√¨nh' : 'T·ªïng H·ªçc sinh'}</div>
                        <div class="value">${totalStudents}</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success)">
                        <div style="color:#64748b">ƒêang h·ªçc</div>
                        <div class="value">${activeStudents}</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning)">
                        <div style="color:#64748b">S·ªë l·ªõp</div>
                        <div class="value">${classes}</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger)">
                        <div style="color:#64748b">Vai tr√≤</div>
                        <div class="value" style="font-size:1.2rem">${window.userRole.toUpperCase()}</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi Smart School Pro! üéì</h3>
                    <p style="margin-top:10px; color:#64748b">
                        H·ªá th·ªëng qu·∫£n l√Ω gi√°o d·ª•c theo Ch∆∞∆°ng tr√¨nh 2018 v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng cho Admin, Gi√°o vi√™n v√† Ph·ª• huynh.
                    </p>
                </div>
            `;
        }

        // STUDENTS
        function renderStudents() {
            let students = Object.values(window.localData.students);
            
            // Filter for teacher - only their class
            if (window.userRole === 'teacher' && window.teacherClass) {
                students = students.filter(s => s.classRoom === window.teacherClass || s.class === window.teacherClass);
            }
            
            let html = `
                <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap">
                    ${window.userRole === 'admin' ? `
                        <button class="btn btn-primary" onclick="openStudentModal()">
                            <i class="fas fa-plus"></i> Th√™m H·ªçc sinh
                        </button>
                        <button class="btn btn-success" onclick="exportExcel()">
                            <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                        </button>
                        <label class="btn btn-warning" style="margin:0">
                            <i class="fas fa-upload"></i> Nh·∫≠p Excel
                            <input type="file" accept=".xlsx,.xls" onchange="importExcel(this)" style="display:none">
                        </label>
                    ` : ''}
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th><th>M√£ HS</th><th>H·ªç t√™n</th><th>L·ªõp</th>
                                <th>Gi·ªõi t√≠nh</th><th>Ng√†y sinh</th><th>Tr·∫°ng th√°i</th>
                                ${window.userRole === 'admin' ? '<th>Thao t√°c</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="student-tbody">
            `;
            
            students.forEach((s, i) => {
                const statusBadge = s.status === 'active' ? 'badge-success' : 'badge-danger';
                html += `<tr>
                    <td>${i+1}</td>
                    <td>${s.code || s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.classRoom || s.class || '-'}</td>
                    <td>${s.gender || '-'}</td>
                    <td>${s.dob || '-'}</td>
                    <td><span class="badge ${statusBadge}">${s.status === 'active' ? 'ƒêang h·ªçc' : 'Ngh·ªâ h·ªçc'}</span></td>
                    ${window.userRole === 'admin' ? `
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editStudent('${s.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    ` : ''}
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
            document.getElementById('content').innerHTML = html;
        }

        window.openStudentModal = () => {
            window.editingStudentId = null;
            document.getElementById('modal-student-title').textContent = 'Th√™m H·ªçc sinh';
            document.getElementById('student-form').reset();
            document.getElementById('modal-student').style.display = 'flex';
        }

        window.editStudent = (id) => {
            const student = window.localData.students[id];
            if (!student) return;
            
            window.editingStudentId = id;
            document.getElementById('modal-student-title').textContent = 'S·ª≠a H·ªçc sinh';
            
            const form = document.getElementById('student-form');
            form.code.value = student.code || '';
            form.name.value = student.name || '';
            form.classRoom.value = student.classRoom || student.class || '';
            form.gender.value = student.gender || 'Nam';
            form.dob.value = student.dob || '';
            form.sosPhone.value = student.sosPhone || '';
            form.dadName.value = student.dadName || '';
            form.dadPhone.value = student.dadPhone || '';
            form.momName.value = student.momName || '';
            form.momPhone.value = student.momPhone || '';
            
            document.getElementById('modal-student').style.display = 'flex';
        }

        window.saveStudent = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                code: form.code.value,
                name: form.name.value,
                classRoom: form.classRoom.value,
                class: form.classRoom.value,
                gender: form.gender.value,
                dob: form.dob.value,
                sosPhone: form.sosPhone.value,
                dadName: form.dadName.value,
                dadPhone: form.dadPhone.value,
                momName: form.momName.value,
                momPhone: form.momPhone.value,
                status: 'active',
                createdAt: Date.now()
            };
            
            try {
                if (window.editingStudentId) {
                    await update(ref(db, `students/${window.editingStudentId}`), data);
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t h·ªçc sinh', 'success');
                } else {
                    const newRef = push(ref(db, 'students'));
                    data.id = newRef.key;
                    await set(newRef, data);
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m h·ªçc sinh m·ªõi', 'success');
                }
                closeModal('modal-student');
            } catch (error) {
                Swal.fire('L·ªói', error.message, 'error');
            }
        }

        window.deleteStudent = async (id) => {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            });
            
            if (result.isConfirmed) {
                try {
                    await remove(ref(db, `students/${id}`));
                    Swal.fire('ƒê√£ x√≥a', 'H·ªçc sinh ƒë√£ ƒë∆∞·ª£c x√≥a', 'success');
                } catch (error) {
                    Swal.fire('L·ªói', error.message, 'error');
                }
            }
        }

        // EXCEL
        window.exportExcel = () => {
            const students = Object.values(window.localData.students);
            const data = students.map(s => ({
                "M√£ HS": s.code || s.id,
                "H·ªç v√† T√™n": s.name,
                "L·ªõp": s.classRoom || s.class,
                "Gi·ªõi t√≠nh": s.gender,
                "Ng√†y sinh": s.dob,
                "Tr·∫°ng th√°i": s.status,
                "SƒêT Kh·∫©n c·∫•p": s.sosPhone,
                "Cha": s.dadName,
                "SƒêT Cha": s.dadPhone,
                "M·∫π": s.momName,
                "SƒêT M·∫π": s.momPhone
            }));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "DanhSach");
            XLSX.writeFile(wb, "Danh_Sach_HS.xlsx");
        }

        window.importExcel = (inp) => {
            const f = inp.files[0];
            if (!f) return;
            inp.value = '';
            
            const r = new FileReader();
            r.onload = async (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { raw: false, defval: "" });
                    
                    if (json.length === 0) {
                        Swal.fire('L·ªói', 'File tr·ªëng', 'error');
                        return;
                    }
                    
                    let count = 0;
                    for (const row of json) {
                        if (!row['H·ªç T√™n'] && !row['H·ªç v√† T√™n']) continue;
                        
                        const sData = {
                            code: row['M√£ HS'] || 'HS' + Math.floor(Math.random() * 99999),
                            name: row['H·ªç T√™n'] || row['H·ªç v√† T√™n'],
                            classRoom: row['L·ªõp'] ? row['L·ªõp'].toString().toUpperCase() : '?',
                            class: row['L·ªõp'] ? row['L·ªõp'].toString().toUpperCase() : '?',
                            gender: row['Gi·ªõi t√≠nh'] || 'Nam',
                            dob: row['Ng√†y sinh'] || '',
                            status: 'active',
                            sosPhone: row['SƒêT Kh·∫©n c·∫•p'] || '',
                            dadName: row['H·ªç t√™n Cha'] || '',
                            dadPhone: row['SƒêT Cha'] || '',
                            momName: row['H·ªç t√™n M·∫π'] || '',
                            momPhone: row['SƒêT M·∫π'] || '',
                            createdAt: Date.now()
                        };
                        
                        const newRef = push(ref(db, 'students'));
                        sData.id = newRef.key;
                        await set(newRef, sData);
                        count++;
                    }
                    
                    Swal.fire('Th√†nh c√¥ng', `ƒê√£ nh·∫≠p ${count} h·ªçc sinh`, 'success');
                } catch (error) {
                    Swal.fire('L·ªói file', 'Ki·ªÉm tra l·∫°i file Excel', 'error');
                }
            };
            r.readAsArrayBuffer(f);
        }

        // ATTENDANCE
        function renderAttendance() {
            if (!window.teacherClass && window.userRole === 'teacher') {
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <p>B·∫°n c·∫ßn ƒë∆∞·ª£c ph√¢n c√¥ng l·ªõp ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng ƒëi·ªÉm danh.</p>
                    </div>
                `;
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <div style="display:flex; gap:15px; align-items:center; margin-bottom:20px">
                        <div>
                            <label>Ch·ªçn ng√†y:</label>
                            <input type="date" id="attendance-date" class="form-control" value="${today}" 
                                   onchange="loadAttendance()" style="display:inline-block; width:auto; margin-left:10px">
                        </div>
                        <button class="btn btn-success" onclick="saveAttendance()">
                            <i class="fas fa-save"></i> L∆∞u ƒëi·ªÉm danh
                        </button>
                    </div>
                    
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th><th>M√£ HS</th><th>H·ªç t√™n</th>
                                    <th style="text-align:center">Tr·∫°ng th√°i</th><th>Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-tbody"></tbody>
                        </table>
                    </div>
                </div>
            `;
            loadAttendance();
        }

        window.loadAttendance = async () => {
            if (!window.teacherClass && window.userRole === 'teacher') return;
            
            const date = document.getElementById('attendance-date').value;
            let students = Object.values(window.localData.students);
            
            if (window.userRole === 'teacher') {
                students = students.filter(x => (x.classRoom === window.teacherClass || x.class === window.teacherClass));
            }
            
            const snap = await get(child(ref(db), `attendance/${window.teacherClass || 'all'}/${date}`));
            const attData = snap.exists() ? snap.val() : {};
            
            let html = '';
            students.forEach((st, i) => {
                const s = attData[st.code || st.id] || {};
                html += `<tr>
                    <td>${i+1}</td>
                    <td>${st.code || st.id}</td>
                    <td>${st.name}</td>
                    <td style="text-align:center">
                        <select id="att-s-${st.code || st.id}" class="form-control">
                            <option value="present" ${s.status==='present'?'selected':''}>C√≥ m·∫∑t</option>
                            <option value="p" ${s.status==='p'?'selected':''}>V·∫Øng P</option>
                            <option value="kp" ${s.status==='kp'?'selected':''}>V·∫Øng KP</option>
                        </select>
                    </td>
                    <td><input type="text" id="att-n-${st.code || st.id}" class="form-control" value="${s.note||''}"></td>
                </tr>`;
            });
            document.getElementById('attendance-tbody').innerHTML = html;
        }

        window.saveAttendance = async () => {
            const date = document.getElementById('attendance-date').value;
            if (!date) {
                Swal.fire('L·ªói', 'Ch·ªçn ng√†y', 'warning');
                return;
            }
            
            let students = Object.values(window.localData.students);
            if (window.userRole === 'teacher') {
                students = students.filter(x => (x.classRoom === window.teacherClass || x.class === window.teacherClass));
            }
            
            const updates = {};
            students.forEach(st => {
                const id = st.code || st.id;
                updates[`attendance/${window.teacherClass || 'all'}/${date}/${id}`] = {
                    status: document.getElementById(`att-s-${id}`).value,
                    note: document.getElementById(`att-n-${id}`).value
                };
            });
            
            try {
                await update(ref(db), updates);
                Swal.fire('Th√†nh c√¥ng', 'ƒê√£ l∆∞u ƒëi·ªÉm danh', 'success');
            } catch (error) {
                Swal.fire('L·ªói', error.message, 'error');
            }
        }

        // SCORES - CH∆Ø∆†NG TR√åNH 2018
        function renderScores() {
            let students = Object.values(window.localData.students);
            
            if (window.userRole === 'teacher' && window.teacherClass) {
                students = students.filter(s => s.classRoom === window.teacherClass || s.class === window.teacherClass);
            }
            
            document.getElementById('content').innerHTML = `
                <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap">
                    <button class="btn btn-success" onclick="exportScoreExcel()">
                        <i class="fas fa-file-excel"></i> Xu·∫•t b√°o c√°o ƒëi·ªÉm Excel
                    </button>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th><th>M√£ HS</th><th>H·ªç t√™n</th><th>L·ªõp</th>
                                <th>ƒêi·ªÉm HK1</th><th>ƒêi·ªÉm HK2</th><th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="score-tbody">
                        ${students.map((s, i) => {
                            const scores1 = window.localData.scores[s.id]?.semester1 || {};
                            const scores2 = window.localData.scores[s.id]?.semester2 || {};
                            const avg1 = calculateAverage(scores1);
                            const avg2 = calculateAverage(scores2);
                            
                            return `<tr>
                                <td>${i+1}</td>
                                <td>${s.code || s.id}</td>
                                <td>${s.name}</td>
                                <td>${s.classRoom || s.class}</td>
                                <td>${avg1 ? avg1.toFixed(1) : '-'}</td>
                                <td>${avg2 ? avg2.toFixed(1) : '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="openScoreModal('${s.id}')">
                                        <i class="fas fa-edit"></i> Nh·∫≠p ƒëi·ªÉm
                                    </button>
                                </td>
                            </tr>`;
                        }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function calculateAverage(semesterScores) {
            const subjects = Object.keys(semesterScores);
            if (subjects.length === 0) return 0;
            
            const sum = subjects.reduce((total, subject) => {
                const avg = semesterScores[subject]?.average || 0;
                return total + avg;
            }, 0);
            
            return sum / subjects.length;
        }

        window.openScoreModal = (studentId) => {
            window.currentScoreStudent = studentId;
            const student = window.localData.students[studentId];
            document.getElementById('score-student-name').textContent = student.name;
            document.getElementById('modal-score').style.display = 'flex';
            loadScoreForm();
        }

        window.loadScoreForm = () => {
            const student = window.localData.students[window.currentScoreStudent];
            const semester = document.getElementById('score-semester').value;
            const classNum = (student.classRoom || student.class || '1').charAt(0);
            const subjects = window.PRIMARY_SUBJECTS[classNum] || window.PRIMARY_SUBJECTS['1'];
            
            const existingScores = window.localData.scores[window.currentScoreStudent]?.[`semester${semester}`] || {};
            
            let html = `
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>M√¥n h·ªçc</th>
                            <th>TX1</th><th>TX2</th><th>TX3</th>
                            <th>GK</th><th>CK</th><th>TB</th><th>Nh·∫≠n x√©t</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            subjects.forEach(subject => {
                const scores = existingScores[subject] || {};
                const avg = scores.average || '';
                
                html += `<tr>
                    <td style="font-weight:600">${subject}</td>
                    <td><input type="number" class="score-input" id="tx1-${subject}" value="${scores.tx1 || ''}" min="0" max="10" step="0.1"></td>
                    <td><input type="number" class="score-input" id="tx2-${subject}" value="${scores.tx2 || ''}" min="0" max="10" step="0.1"></td>
                    <td><input type="number" class="score-input" id="tx3-${subject}" value="${scores.tx3 || ''}" min="0" max="10" step="0.1"></td>
                    <td><input type="number" class="score-input" id="gk-${subject}" value="${scores.gk || ''}" min="0" max="10" step="0.1"></td>
                    <td><input type="number" class="score-input" id="ck-${subject}" value="${scores.ck || ''}" min="0" max="10" step="0.1"></td>
                    <td><input type="number" class="score-input" id="avg-${subject}" value="${avg}" readonly style="background:#f1f5f9; font-weight:600"></td>
                    <td><input type="text" class="form-control" id="comment-${subject}" value="${scores.comment || ''}" placeholder="Nh·∫≠n x√©t"></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('score-form-container').innerHTML = html;
            
            // Auto calculate average
            subjects.forEach(subject => {
                ['tx1', 'tx2', 'tx3', 'gk', 'ck'].forEach(type => {
                    const input = document.getElementById(`${type}-${subject}`);
                    if (input) {
                        input.addEventListener('input', () => calculateSubjectAverage(subject));
                    }
                });
            });
        }

        function calculateSubjectAverage(subject) {
            const tx1 = parseFloat(document.getElementById(`tx1-${subject}`).value) || 0;
            const tx2 = parseFloat(document.getElementById(`tx2-${subject}`).value) || 0;
            const tx3 = parseFloat(document.getElementById(`tx3-${subject}`).value) || 0;
            const gk = parseFloat(document.getElementById(`gk-${subject}`).value) || 0;
            const ck = parseFloat(document.getElementById(`ck-${subject}`).value) || 0;
            
            // Formula: (TX1 + TX2 + TX3 + GK*2 + CK*3) / 8
            const average = (tx1 + tx2 + tx3 + gk*2 + ck*3) / 8;
            document.getElementById(`avg-${subject}`).value = average.toFixed(1);
        }

        window.saveScores = async () => {
            const student = window.localData.students[window.currentScoreStudent];
            const semester = document.getElementById('score-semester').value;
            const classNum = (student.classRoom || student.class || '1').charAt(0);
            const subjects = window.PRIMARY_SUBJECTS[classNum] || window.PRIMARY_SUBJECTS['1'];
            
            const semesterData = {};
            
            subjects.forEach(subject => {
                semesterData[subject] = {
                    tx1: parseFloat(document.getElementById(`tx1-${subject}`).value) || 0,
                    tx2: parseFloat(document.getElementById(`tx2-${subject}`).value) || 0,
                    tx3: parseFloat(document.getElementById(`tx3-${subject}`).value) || 0,
                    gk: parseFloat(document.getElementById(`gk-${subject}`).value) || 0,
                    ck: parseFloat(document.getElementById(`ck-${subject}`).value) || 0,
                    average: parseFloat(document.getElementById(`avg-${subject}`).value) || 0,
                    comment: document.getElementById(`comment-${subject}`).value || ''
                };
            });
            
            try {
                await update(ref(db, `scores/${window.currentScoreStudent}/semester${semester}`), semesterData);
                Swal.fire('Th√†nh c√¥ng', 'ƒê√£ l∆∞u ƒëi·ªÉm', 'success');
                closeModal('modal-score');
                renderScores();
            } catch (error) {
                Swal.fire('L·ªói', error.message, 'error');
            }
        }

        window.exportScoreExcel = () => {
            let students = Object.values(window.localData.students);
            
            if (window.userRole === 'teacher' && window.teacherClass) {
                students = students.filter(s => s.classRoom === window.teacherClass || s.class === window.teacherClass);
            }
            
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: H·ªçc k·ª≥ 1
            const data1 = [];
            students.forEach(s => {
                const classNum = (s.classRoom || s.class || '1').charAt(0);
                const subjects = window.PRIMARY_SUBJECTS[classNum] || window.PRIMARY_SUBJECTS['1'];
                const scores1 = window.localData.scores[s.id]?.semester1 || {};
                
                const row = {
                    'M√£ HS': s.code || s.id,
                    'H·ªç t√™n': s.name,
                    'L·ªõp': s.classRoom || s.class
                };
                
                subjects.forEach(subject => {
                    const sc = scores1[subject] || {};
                    row[`${subject} - TB`] = sc.average || '';
                    row[`${subject} - NX`] = sc.comment || '';
                });
                
                data1.push(row);
            });
            
            // Sheet 2: H·ªçc k·ª≥ 2
            const data2 = [];
            students.forEach(s => {
                const classNum = (s.classRoom || s.class || '1').charAt(0);
                const subjects = window.PRIMARY_SUBJECTS[classNum] || window.PRIMARY_SUBJECTS['1'];
                const scores2 = window.localData.scores[s.id]?.semester2 || {};
                
                const row = {
                    'M√£ HS': s.code || s.id,
                    'H·ªç t√™n': s.name,
                    'L·ªõp': s.classRoom || s.class
                };
                
                subjects.forEach(subject => {
                    const sc = scores2[subject] || {};
                    row[`${subject} - TB`] = sc.average || '';
                    row[`${subject} - NX`] = sc.comment || '';
                });
                
                data2.push(row);
            });
            
            // Sheet 3: T·ªïng k·∫øt
            const dataSummary = [];
            students.forEach(s => {
                const scores1 = window.localData.scores[s.id]?.semester1 || {};
                const scores2 = window.localData.scores[s.id]?.semester2 || {};
                const avg1 = calculateAverage(scores1);
                const avg2 = calculateAverage(scores2);
                const avgYear = ((avg1 + avg2) / 2).toFixed(1);
                
                dataSummary.push({
                    'M√£ HS': s.code || s.id,
                    'H·ªç t√™n': s.name,
                    'L·ªõp': s.classRoom || s.class,
                    'TB HK1': avg1 ? avg1.toFixed(1) : '',
                    'TB HK2': avg2 ? avg2.toFixed(1) : '',
                    'TB C·∫£ nƒÉm': avgYear !== 'NaN' ? avgYear : '',
                    'X·∫øp lo·∫°i': avgYear >= 8 ? 'Gi·ªèi' : avgYear >= 6.5 ? 'Kh√°' : avgYear >= 5 ? 'TB' : 'Y·∫øu'
                });
            });
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data1), "HK1");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data2), "HK2");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataSummary), "TongKet");
            
            XLSX.writeFile(wb, "Bao_Cao_Diem.xlsx");
        }

        // FINANCE
        function renderFinance() {
            if (window.userRole === 'teacher') {
                // Teacher view - only payment status
                renderFinanceTeacher();
                return;
            }
            
            // Admin view - full management
            const transactions = Object.values(window.localData.finance);
            
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const balance = totalIncome - totalExpense;
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const thisMonthTrans = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            
            const monthIncome = thisMonthTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const monthExpense = thisMonthTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            
            document.getElementById('content').innerHTML = `
                <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap">
                    <button class="btn btn-primary" onclick="openFinanceModal()">
                        <i class="fas fa-plus"></i> Th√™m Thu/Chi
                    </button>
                    <button class="btn btn-success" onclick="exportFinanceExcel()">
                        <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                    </button>
                    <select id="finance-filter" class="custom-select" onchange="filterFinance()">
                        <option value="all">T·∫•t c·∫£ giao d·ªãch</option>
                        <option value="income">Ch·ªâ Thu</option>
                        <option value="expense">Ch·ªâ Chi</option>
                        <option value="month">Th√°ng n√†y</option>
                    </select>
                </div>
                
                <div class="grid-4" style="margin-bottom:20px">
                    <div class="stat-card" style="border-left-color: var(--success)">
                        <div style="color:#64748b">T·ªïng Thu</div>
                        <div class="value" style="color:var(--success)">${totalIncome.toLocaleString('vi-VN')}ƒë</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger)">
                        <div style="color:#64748b">T·ªïng Chi</div>
                        <div class="value" style="color:var(--danger)">${totalExpense.toLocaleString('vi-VN')}ƒë</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--primary)">
                        <div style="color:#64748b">S·ªë d∆∞</div>
                        <div class="value" style="color:${balance >= 0 ? 'var(--success)' : 'var(--danger)'}">${balance.toLocaleString('vi-VN')}ƒë</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning)">
                        <div style="color:#64748b">Thu/Chi th√°ng n√†y</div>
                        <div class="value" style="font-size:1rem">
                            <span style="color:var(--success)">${monthIncome.toLocaleString('vi-VN')}</span> / 
                            <span style="color:var(--danger)">${monthExpense.toLocaleString('vi-VN')}</span>
                        </div>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th><th>Ng√†y</th><th>Lo·∫°i</th><th>Danh m·ª•c</th>
                                <th>S·ªë ti·ªÅn</th><th>M√£ HS</th><th>PT thanh to√°n</th>
                                <th>Ghi ch√∫</th><th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="finance-tbody"></tbody>
                    </table>
                </div>
            `;
            
            renderFinanceTable(transactions);
        }

        function renderFinanceTeacher() {
            // Teacher can only view payment status of their students
            let students = Object.values(window.localData.students)
                .filter(s => s.classRoom === window.teacherClass || s.class === window.teacherClass);
            
            const transactions = Object.values(window.localData.finance)
                .filter(t => t.type === 'income' && ['tuition', 'exam_fee', 'uniform', 'meal'].includes(t.category));
            
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h3>Danh s√°ch ƒë√≥ng ti·ªÅn l·ªõp ${window.teacherClass}</h3>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th><th>M√£ HS</th><th>H·ªç t√™n</th>
                                <th>H·ªçc ph√≠</th><th>Ph√≠ thi</th><th>ƒê·ªìng ph·ª•c</th><th>Ti·ªÅn ƒÉn</th>
                                <th>T·ªïng ƒë√£ ƒë√≥ng</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${students.map((s, i) => {
                            const studentTrans = transactions.filter(t => t.studentCode === s.code || t.studentCode === s.id);
                            const tuition = studentTrans.filter(t => t.category === 'tuition').reduce((sum, t) => sum + t.amount, 0);
                            const exam = studentTrans.filter(t => t.category === 'exam_fee').reduce((sum, t) => sum + t.amount, 0);
                            const uniform = studentTrans.filter(t => t.category === 'uniform').reduce((sum, t) => sum + t.amount, 0);
                            const meal = studentTrans.filter(t => t.category === 'meal').reduce((sum, t) => sum + t.amount, 0);
                            const total = tuition + exam + uniform + meal;
                            
                            return `<tr>
                                <td>${i+1}</td>
                                <td>${s.code || s.id}</td>
                                <td>${s.name}</td>
                                <td>${tuition.toLocaleString('vi-VN')}ƒë</td>
                                <td>${exam.toLocaleString('vi-VN')}ƒë</td>
                                <td>${uniform.toLocaleString('vi-VN')}ƒë</td>
                                <td>${meal.toLocaleString('vi-VN')}ƒë</td>
                                <td style="font-weight:600; color:var(--primary)">${total.toLocaleString('vi-VN')}ƒë</td>
                            </tr>`;
                        }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderFinanceTable(transactions) {
            const sorted = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            sorted.forEach((t, i) => {
                const typeBadge = t.type === 'income' ? 'badge-success' : 'badge-danger';
                const typeText = t.type === 'income' ? 'Thu' : 'Chi';
                const amountColor = t.type === 'income' ? 'var(--success)' : 'var(--danger)';
                
                const categoryNames = {
                    'tuition': 'H·ªçc ph√≠', 'exam_fee': 'Ph√≠ thi', 'uniform': 'ƒê·ªìng ph·ª•c',
                    'meal': 'Ti·ªÅn ƒÉn', 'other_income': t.customIncome || 'Thu kh√°c',
                    'salary': 'L∆∞∆°ng', 'utility': 'ƒêi·ªán n∆∞·ªõc', 'maintenance': 'B·∫£o tr√¨',
                    'supplies': 'VƒÉn ph√≤ng ph·∫©m', 'other_expense': 'Chi kh√°c'
                };
                
                const paymentNames = {
                    'cash': 'Ti·ªÅn m·∫∑t', 'bank': 'Chuy·ªÉn kho·∫£n', 'card': 'Th·∫ª'
                };
                
                html += `<tr>
                    <td>${i+1}</td>
                    <td>${new Date(t.date).toLocaleDateString('vi-VN')}</td>
                    <td><span class="badge ${typeBadge}">${typeText}</span></td>
                    <td>${categoryNames[t.category] || t.category}</td>
                    <td style="font-weight:600; color:${amountColor}">${(t.amount || 0).toLocaleString('vi-VN')}ƒë</td>
                    <td>${t.studentCode || '-'}</td>
                    <td>${paymentNames[t.paymentMethod] || '-'}</td>
                    <td>${t.note || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editFinance('${t.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFinance('${t.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('finance-tbody').innerHTML = html;
        }

        window.toggleFinanceCategory = () => {
            const type = document.querySelector('[name="type"]').value;
            const category = document.getElementById('finance-category');
            const customField = document.getElementById('custom-income-field');
            
            category.addEventListener('change', function() {
                if (this.value === 'other_income') {
                    customField.style.display = 'block';
                    customField.querySelector('input').required = true;
                } else {
                    customField.style.display = 'none';
                    customField.querySelector('input').required = false;
                }
            });
        }

        window.openFinanceModal = () => {
            window.editingFinanceId = null;
            document.getElementById('modal-finance-title').textContent = 'Th√™m Kho·∫£n Thu/Chi';
            const form = document.getElementById('finance-form');
            form.reset();
            form.date.value = new Date().toISOString().split('T')[0];
            document.getElementById('custom-income-field').style.display = 'none';
            document.getElementById('modal-finance').style.display = 'flex';
        }

        window.editFinance = (id) => {
            const transaction = window.localData.finance[id];
            if (!transaction) return;
            
            window.editingFinanceId = id;
            document.getElementById('modal-finance-title').textContent = 'S·ª≠a Giao d·ªãch';
            
            const form = document.getElementById('finance-form');
            form.type.value = transaction.type;
            form.category.value = transaction.category;
            form.amount.value = transaction.amount;
            form.date.value = transaction.date;
            form.studentCode.value = transaction.studentCode || '';
            form.paymentMethod.value = transaction.paymentMethod;
            form.note.value = transaction.note || '';
            
            if (transaction.category === 'other_income' && transaction.customIncome) {
                document.getElementById('custom-income-field').style.display = 'block';
                form.customIncome.value = transaction.customIncome;
            }
            
            document.getElementById('modal-finance').style.display = 'flex';
        }

        window.saveFinance = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            const data = {
                type: form.type.value,
                category: form.category.value,
                amount: parseFloat(form.amount.value),
                date: form.date.value,
                studentCode: form.studentCode.value,
                paymentMethod: form.paymentMethod.value,
                note: form.note.value,
                createdBy: window.currentUser.email,
                createdAt: Date.now()
            };
            
            if (form.category.value === 'other_income') {
                data.customIncome = form.customIncome.value;
            }
            
            try {
                if (window.editingFinanceId) {
                    await update(ref(db, `finance/${window.editingFinanceId}`), data);
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t giao d·ªãch', 'success');
                } else {
                    const newRef = push(ref(db, 'finance'));
                    data.id = newRef.key;
                    await set(newRef, data);
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m giao d·ªãch m·ªõi', 'success');
                }
                closeModal('modal-finance');
            } catch (error) {
                Swal.fire('L·ªói', error.message, 'error');
            }
        }

        window.deleteFinance = async (id) => {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a giao d·ªãch n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            });
            
            if (result.isConfirmed) {
                try {
                    await remove(ref(db, `finance/${id}`));
                    Swal.fire('ƒê√£ x√≥a', 'Giao d·ªãch ƒë√£ ƒë∆∞·ª£c x√≥a', 'success');
                } catch (error) {
                    Swal.fire('L·ªói', error.message, 'error');
                }
            }
        }

        window.filterFinance = () => {
            const filter = document.getElementById('finance-filter').value;
            let transactions = Object.values(window.localData.finance);
            
            if (filter === 'income') {
                transactions = transactions.filter(t => t.type === 'income');
            } else if (filter === 'expense') {
                transactions = transactions.filter(t => t.type === 'expense');
            } else if (filter === 'month') {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                transactions = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
            }
            
            renderFinanceTable(transactions);
        }

        window.exportFinanceExcel = () => {
            const transactions = Object.values(window.localData.finance);
            
            const categoryNames = {
                'tuition': 'H·ªçc ph√≠', 'exam_fee': 'Ph√≠ thi', 'uniform': 'ƒê·ªìng ph·ª•c',
                'meal': 'Ti·ªÅn ƒÉn', 'other_income': 'Thu kh√°c',
                'salary': 'L∆∞∆°ng', 'utility': 'ƒêi·ªán n∆∞·ªõc', 'maintenance': 'B·∫£o tr√¨',
                'supplies': 'VƒÉn ph√≤ng ph·∫©m', 'other_expense': 'Chi kh√°c'
            };
            
            const paymentNames = {
                'cash': 'Ti·ªÅn m·∫∑t', 'bank': 'Chuy·ªÉn kho·∫£n', 'card': 'Th·∫ª'
            };
            
            const data = transactions.map(t => ({
                "Ng√†y": t.date,
                "Lo·∫°i": t.type === 'income' ? 'Thu' : 'Chi',
                "Danh m·ª•c": t.customIncome || categoryNames[t.category] || t.category,
                "S·ªë ti·ªÅn": t.amount,
                "M√£ HS": t.studentCode || '',
                "PT thanh to√°n": paymentNames[t.paymentMethod] || '',
                "Ghi ch√∫": t.note || '',
                "Ng∆∞·ªùi t·∫°o": t.createdBy || ''
            }));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "ThuChi");
            XLSX.writeFile(wb, "Bao_Cao_Thu_Chi.xlsx");
        }

        // USERS
        function renderUsers() {
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h3>Qu·∫£n l√Ω Users</h3>
                    <p style="color:#dc2626; margin-top:10px">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>L∆∞u √Ω:</strong> X√≥a user s·∫Ω x√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n tr√™n Firebase Auth. Ng∆∞·ªùi d√πng s·∫Ω kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p l·∫°i.
                    </p>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th><th>Vai tr√≤</th><th>Th√¥ng tin</th>
                                <th>Ng√†y t·∫°o</th>
                                ${window.userRole === 'admin' ? '<th style="text-align:center">Thao t√°c</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="user-list-body"></tbody>
                    </table>
                </div>
            `;
            loadUsers();
        }

        window.loadUsers = () => {
            onValue(ref(db, 'users'), snap => {
                const users = snap.val() || {};
                let html = '';
                for (let uid in users) {
                    const u = users[uid];
                    
                    // Don't allow deleting current user
                    const isCurrentUser = window.currentUser && window.currentUser.uid === uid;
                    
                    html += `<tr>
                        <td>${u.email}${isCurrentUser ? ' <span class="badge badge-info">B·∫°n</span>' : ''}</td>
                        <td><span class="badge badge-warning">${u.role}</span></td>
                        <td>${u.assignedClass || u.studentId || '-'}</td>
                        <td>${new Date(u.createdAt).toLocaleDateString('vi-VN')}</td>
                        ${window.userRole === 'admin' ? `
                            <td style="text-align:center">
                                ${!isCurrentUser ? `
                                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${uid}', '${u.email}')">
                                        <i class="fas fa-trash"></i> X√≥a
                                    </button>
                                ` : `
                                    <span style="color:#94a3b8; font-size:0.85rem">Kh√¥ng th·ªÉ x√≥a</span>
                                `}
                            </td>
                        ` : ''}
                    </tr>`;
                }
                document.getElementById('user-list-body').innerHTML = html;
            });
        }

        window.deleteUser = async (uid, email) => {
            // Double check admin permission
            if (window.userRole !== 'admin') {
                Swal.fire('T·ª´ ch·ªëi', 'Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn x√≥a user', 'error');
                return;
            }

            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a User?',
                html: `
                    <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user <strong>${email}</strong>?</p>
                    <p style="color:#dc2626; margin-top:10px">
                        <i class="fas fa-exclamation-triangle"></i> 
                        H√†nh ƒë·ªông n√†y s·∫Ω:
                    </p>
                    <ul style="text-align:left; color:#64748b; margin-top:10px; margin-left:20px">
                        <li>X√≥a t√†i kho·∫£n tr√™n Firebase Authentication</li>
                        <li>X√≥a th√¥ng tin user trong Database</li>
                        <li>Ng∆∞·ªùi d√πng s·∫Ω <strong>kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p</strong> l·∫°i</li>
                        <li><strong>KH√îNG TH·ªÇ HO√ÄN T√ÅC</strong></li>
                    </ul>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a vƒ©nh vi·ªÖn',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#64748b'
            });
            
            if (!result.isConfirmed) return;

            try {
                // Show loading
                Swal.fire({
                    title: 'ƒêang x√≥a...',
                    html: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Method 1: Try Cloud Function (if deployed)
                try {
                    const deleteUserFunc = httpsCallable(functions, 'deleteUserCallable');
                    const response = await deleteUserFunc({ uid: uid });
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ƒê√£ x√≥a!',
                        text: `User ${email} ƒë√£ ƒë∆∞·ª£c x√≥a vƒ©nh vi·ªÖn kh·ªèi h·ªá th·ªëng.`,
                        confirmButtonText: 'OK'
                    });
                    
                } catch (cloudFunctionError) {
                    console.error('Cloud Function error:', cloudFunctionError);
                    
                    // Method 2: Fallback - Delete from Database only
                    // Show warning that Auth deletion needs manual action
                    await remove(ref(db, `users/${uid}`));
                    
                    Swal.fire({
                        icon: 'warning',
                        title: 'ƒê√£ x√≥a kh·ªèi Database',
                        html: `
                            <p>User ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi Database.</p>
                            <div style="background:#fef3c7; padding:15px; border-radius:8px; margin-top:15px; text-align:left">
                                <p style="color:#92400e; margin-bottom:10px">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>C·∫ßn th√™m 1 b∆∞·ªõc:</strong>
                                </p>
                                <p style="color:#64748b; font-size:0.9rem">
                                    Do ch∆∞a c√†i ƒë·∫∑t Cloud Function, b·∫°n c·∫ßn x√≥a t√†i kho·∫£n Auth th·ªß c√¥ng:
                                </p>
                                <ol style="color:#64748b; font-size:0.9rem; margin-top:10px; margin-left:20px">
                                    <li>V√†o <a href="https://console.firebase.google.com" target="_blank" style="color:#2563eb">Firebase Console</a></li>
                                    <li>Ch·ªçn <strong>Authentication</strong> ‚Üí <strong>Users</strong></li>
                                    <li>T√¨m user: <strong>${email}</strong></li>
                                    <li>Nh·∫•n <strong>‚ãÆ</strong> ‚Üí <strong>Delete account</strong></li>
                                </ol>
                            </div>
                            <p style="margin-top:15px; font-size:0.85rem; color:#64748b">
                                <strong>L∆∞u √Ω:</strong> User v·∫´n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p n·∫øu kh√¥ng x√≥a tr√™n Auth.
                            </p>
                        `,
                        confirmButtonText: 'ƒê√£ hi·ªÉu',
                        width: 600
                    });
                }

            } catch (error) {
                console.error('Error deleting user:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: error.message || 'Kh√¥ng th·ªÉ x√≥a user',
                    confirmButtonText: 'OK'
                });
            }
        }

        // MODAL
        window.closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>
</html>
