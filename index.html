<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School Pro - H·ªá Th·ªëng Qu·∫£n L√Ω Gi√°o D·ª•c</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 

    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #16a34a;
            --warning: #d97706; --danger: #dc2626; --bg-light: #f1f5f9;
            --sidebar-w: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-light); height: 100vh; overflow: hidden; font-size: 14px; }

        /* --- LAYOUT --- */
        #app-container { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-w); background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 1.5rem; font-size: 1.3rem; font-weight: 700; border-bottom: 1px solid #334155; display:flex; align-items:center; gap:10px; }
        .menu { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .menu-item { padding: 0.8rem 1.5rem; cursor: pointer; color: #94a3b8; display: flex; align-items: center; transition: 0.2s; gap: 12px; }
        .menu-item:hover, .menu-item.active { background: #334155; color: white; border-right: 4px solid var(--primary); }
        
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f8fafc; }
        .top-bar { background: white; padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .content-area { flex: 1; padding: 20px; overflow-y: auto; }

        /* --- AUTH --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3a8a, #2563eb); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .auth-card { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); text-align: center; }
        .auth-inp { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; }
        .btn-auth { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .hidden { display: none !important; }

        /* --- UI COMPONENTS --- */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; font-weight: 500; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }

        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-top: 5px; }

        /* TABLE */
        .table-wrapper { background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f1f5f9; text-align: left; padding: 12px 16px; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; text-transform: uppercase; white-space: nowrap; }
        td { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        
        .avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #e2e8f0; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* MODAL STYLES */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 12px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid #e2e8f0; text-align: right; background: #f8fafc; }

        /* FORM ELEMENTS */
        .form-section { margin-bottom: 25px; }
        .form-section h4 { color: var(--primary); margin-bottom: 15px; font-size: 1rem; border-left: 4px solid var(--primary); padding-left: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #64748b; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        .upload-box { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; background: #f8fafc; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;}
        .upload-box:hover { border-color: var(--primary); background: #eff6ff; }
        #preview-img { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; border: 1px solid #cbd5e1; }

        /* Input mini cho b·∫£ng ƒëi·ªÉm */
        .inp-mini { width: 45px; text-align: center; border: 1px solid #ccc; padding: 4px; border-radius: 4px; }
        .col-calc { background: #f8fafc; font-weight: bold; text-align: center; color: #1e293b; width: 50px; }
        .custom-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; background: white; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color:#1e293b;margin-bottom:5px"><i class="fas fa-school"></i> Smart School</h2>
            <p style="color:#64748b;margin-bottom:20px">H·ªá th·ªëng qu·∫£n l√Ω gi√°o d·ª•c</p>
            <input type="email" id="login-email" class="auth-inp" placeholder="Email qu·∫£n tr·ªã">
            <input type="password" id="login-pass" class="auth-inp" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-auth" onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-graduation-cap"></i> SmartSchool</div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('dashboard')"><i class="fas fa-chart-pie"></i> T·ªïng quan</div>
                <div class="menu-item" onclick="nav('students')"><i class="fas fa-user-graduate"></i> H·ªì s∆° H·ªçc sinh</div>
                <div class="menu-item" onclick="nav('academics')"><i class="fas fa-book"></i> S·ªï ƒëi·ªÉm & M√¥n h·ªçc</div>
                <div class="menu-item" onclick="nav('finance')"><i class="fas fa-file-invoice-dollar"></i> T√†i ch√≠nh</div>
                <div class="menu-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</div>
            </div>
        </div>

        <div class="main">
            <div class="top-bar">
                <div style="font-weight:600; color:#475569" id="page-title">T·ªïng quan</div>
                <div id="user-info" style="font-weight:600; color:var(--primary)">Admin</div>
            </div>

            <div class="content-area">
                
                <div id="view-dashboard" class="view-section">
                    <div class="grid-4">
                        <div class="stat-card"><h3>T·ªïng H·ªçc sinh</h3><div class="value" id="dash-total">0</div></div>
                        <div class="stat-card" style="border-color:#22c55e"><h3>M·ªõi ti·∫øp nh·∫≠n</h3><div class="value" id="dash-new">0</div></div>
                        <div class="stat-card" style="border-color:#f59e0b"><h3>Nam</h3><div class="value" id="dash-male">0</div></div>
                        <div class="stat-card" style="border-color:#dc2626"><h3>N·ªØ</h3><div class="value" id="dash-female">0</div></div>
                    </div>
                    <div class="card" style="margin-top:20px">
                        <h4>Th·ªëng k√™ h·ªçc sinh</h4>
                        <canvas id="genderChart" style="max-height:300px"></canvas>
                    </div>
                </div>

                <div id="view-students" class="view-section hidden">
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                        <div style="display:flex; gap:10px; flex:1; flex-wrap:wrap;">
                            <input type="text" id="search-key" class="form-control" placeholder="üîç T√¨m t√™n/m√£..." style="width: 200px;" onkeyup="renderStudentTable()">
                            <select id="filter-grade" class="form-control" style="width: 120px;" onchange="renderStudentTable()">
                                <option value="">T·∫•t c·∫£ Kh·ªëi</option><option value="1">Kh·ªëi 1</option><option value="2">Kh·ªëi 2</option><option value="3">Kh·ªëi 3</option><option value="4">Kh·ªëi 4</option><option value="5">Kh·ªëi 5</option>
                            </select>
                            <select id="filter-status" class="form-control" style="width: 140px;" onchange="renderStudentTable()">
                                <option value="">M·ªçi tr·∫°ng th√°i</option><option value="active">ƒêang h·ªçc</option><option value="reserved">B·∫£o l∆∞u</option><option value="dropped">Ngh·ªâ h·ªçc</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px;">
                        <button class="btn btn-warning" onclick="downloadTemplate()"><i class="fas fa-download"></i> T·∫£i M·∫´u</button>
                        
                        <button class="btn btn-outline" onclick="exportStudentExcel()"><i class="fas fa-file-export"></i> Xu·∫•t Excel</button>
                        <label class="btn btn-success"><i class="fas fa-file-excel"></i> Nh·∫≠p Excel <input type="file" hidden onchange="importExcel(this)"></label>
                        <button class="btn btn-primary" onclick="openStudentModal()"><i class="fas fa-plus-circle"></i> Th√™m m·ªõi</button>
                    </div>
                    </div>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:60px">·∫¢nh</th>
                                    <th>M√£ HS</th>
                                    <th>H·ªç v√† T√™n</th>
                                    <th>L·ªõp</th>
                                    <th>Ng√†y sinh</th>
                                    <th>Ph·ª• huynh (SƒêT)</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th style="text-align:right">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                </tbody>
                        </table>
                    </div>
                    <div id="count-display" style="margin-top:10px; color:#64748b"></div>
                </div>

                <div id="view-academics" class="view-section hidden">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                            <h3 style="color:var(--primary)"><i class="fas fa-book"></i> Nh·∫≠p ƒêi·ªÉm</h3>
                            <div>
                                <button class="btn btn-primary" onclick="saveCurrentSubject()">L∆∞u ƒëi·ªÉm m√¥n n√†y</button>
                                <button class="btn btn-success" onclick="exportMasterExcel()">Xu·∫•t B√°o C√°o (3 Sheet)</button>
                            </div>
                        </div>
                        <div style="background:#f1f5f9; padding:15px; border-radius:8px; display:flex; gap:10px; flex-wrap:wrap">
                            <select id="acad-grade" class="custom-select" style="width:80px"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
                            <input type="text" id="acad-class" class="custom-select" placeholder="L·ªõp (A,B)" style="width:100px">
                            <select id="acad-subject" class="custom-select" style="flex:1; min-width:150px">
                                <option value="tiengviet">Ti·∫øng Vi·ªát</option><option value="toan">To√°n</option><option value="ngoaingu1">Ngo·∫°i ng·ªØ 1</option><option value="daoduc">ƒê·∫°o ƒë·ª©c</option><option value="tnxh">TN & XH</option><option value="lsdl">L·ªãch s·ª≠ & ƒêL</option><option value="khoahoc">Khoa h·ªçc</option><option value="tinhoc">Tin h·ªçc & CN</option><option value="thechat">Th·ªÉ ch·∫•t</option><option value="nghethuat">Ngh·ªá thu·∫≠t</option><option value="hdtrainghiem">Hƒê Tr·∫£i nghi·ªám</option>
                            </select>
                            <button class="btn btn-warning" onclick="loadClassGrades()">T·∫£i B·∫£ng ƒêi·ªÉm</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="grade-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">H·ªçc sinh</th> <th colspan="3" class="th-hk1">H·ªçc K·ª≥ 1</th> <th colspan="3" class="th-hk2">H·ªçc K·ª≥ 2</th> <th colspan="2" class="th-year">C·∫£ NƒÉm</th> <th rowspan="2">Nh·∫≠n x√©t</th>
                                </tr>
                                <tr>
                                    <th>Gi·ªØa 1</th><th>Cu·ªëi 1</th><th>TB 1</th> <th>Gi·ªØa 2</th><th>Cu·ªëi 2</th><th>TB 2</th> <th>C·∫£ NƒÉm</th><th>XL</th>
                                </tr>
                            </thead>
                            <tbody id="table-grades-body"><tr><td colspan="10" style="text-align:center; padding:20px">Vui l√≤ng ch·ªçn l·ªõp v√† t·∫£i danh s√°ch</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-finance" class="view-section hidden">
                    <div class="grid-4">
                        <div class="stat-card" style="border-color:#6366f1"><h3>Ph·∫£i Thu</h3><div class="value" id="fin-expect">0 ƒë</div></div>
                        <div class="stat-card" style="border-color:#22c55e"><h3>ƒê√£ Thu</h3><div class="value" id="fin-collected" style="color:#16a34a">0 ƒë</div></div>
                        <div class="stat-card" style="border-color:#ef4444"><h3>C√≤n L·∫°i</h3><div class="value" id="fin-remain" style="color:#dc2626">0 ƒë</div></div>
                    </div>
                    <div class="card" style="margin-top:20px">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                            <h3 style="color:var(--primary)">Thu Ph√≠</h3>
                            <button class="btn btn-warning" onclick="document.getElementById('modal-fee').style.display='flex'">C√†i ƒë·∫∑t Kho·∫£n thu</button>
                        </div>
                        <div style="display:flex; gap:10px">
                            <select id="fin-grade" class="custom-select" style="width:120px"><option value="">T·∫•t c·∫£ kh·ªëi</option><option value="1">Kh·ªëi 1</option><option value="2">Kh·ªëi 2</option><option value="3">Kh·ªëi 3</option><option value="4">Kh·ªëi 4</option><option value="5">Kh·ªëi 5</option></select>
                            <input type="text" id="fin-class" class="custom-select" placeholder="L·ªõp (VD: 1A)">
                            <button class="btn btn-primary" onclick="loadFinanceView()">Xem</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="finance-table">
                            <thead id="fin-thead"></thead>
                            <tbody id="fin-tbody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-student" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" style="color:#1e293b; margin:0"><i class="fas fa-user-edit"></i> H·ªì S∆° H·ªçc Sinh</h3>
                <span style="cursor:pointer; font-size:1.5rem" onclick="closeModal('modal-student')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="inp-id">
                
                <div style="display:grid; grid-template-columns: 200px 1fr; gap:30px">
                    <div style="text-align:center;">
                        <div class="upload-box" onclick="document.getElementById('inp-avatar-file').click()">
                            <i class="fas fa-camera" style="font-size:2rem; color:#cbd5e1"></i>
                            <div style="margin-top:5px; font-size:0.8rem; color:#64748b">Ch·ªçn ·∫£nh th·∫ª</div>
                            <img id="preview-img" src="">
                        </div>
                        <input type="file" id="inp-avatar-file" hidden accept="image/*" onchange="handleAvatarPreview(this)">
                        <input type="hidden" id="inp-avatar-base64">
                    </div>

                    <div>
                        <div class="form-section">
                            <h4>Th√¥ng tin c√° nh√¢n</h4>
                            <div class="form-grid">
                                <div class="form-group"><label>M√£ HS</label><input type="text" id="inp-code" class="form-control" placeholder="T·ª± ƒë·ªông"></div>
                                <div class="form-group"><label>H·ªç v√† T√™n (*)</label><input type="text" id="inp-name" class="form-control"></div>
                                <div class="form-group"><label>Gi·ªõi t√≠nh</label><select id="inp-gender" class="form-control"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div>
                                <div class="form-group"><label>Ng√†y sinh</label><input type="text" id="inp-dob" class="form-control" placeholder="dd/mm/yyyy"></div>
                                <div class="form-group"><label>L·ªõp (*)</label><input type="text" id="inp-class" class="form-control" placeholder="VD: 1A"></div>
                                <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="inp-status" class="form-control"><option value="active">ƒêang h·ªçc</option><option value="reserved">B·∫£o l∆∞u</option><option value="dropped">Ngh·ªâ h·ªçc</option></select></div>
                                <div class="form-group"><label>D√¢n t·ªôc</label><input type="text" id="inp-eth" class="form-control" value="Kinh"></div>
                                <div class="form-group"><label>T√¥n gi√°o</label><input type="text" id="inp-rel" class="form-control" value="Kh√¥ng"></div>
                            </div>
                            <div class="form-group" style="margin-top:15px"><label>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫</label><input type="text" id="inp-addr" class="form-control"></div>
                        </div>

                        <div class="form-section">
                            <h4>Gia ƒë√¨nh & Li√™n h·ªá</h4>
                            <div class="form-grid">
                                <div class="form-group"><label>H·ªç t√™n Cha</label><input type="text" id="inp-dad" class="form-control"></div>
                                <div class="form-group"><label>Ngh·ªÅ nghi·ªáp</label><input type="text" id="inp-dad-job" class="form-control"></div>
                                <div class="form-group"><label>SƒêT Cha</label><input type="text" id="inp-dad-phone" class="form-control"></div>
                                
                                <div class="form-group"><label>H·ªç t√™n M·∫π</label><input type="text" id="inp-mom" class="form-control"></div>
                                <div class="form-group"><label>Ngh·ªÅ nghi·ªáp</label><input type="text" id="inp-mom-job" class="form-control"></div>
                                <div class="form-group"><label>SƒêT M·∫π</label><input type="text" id="inp-mom-phone" class="form-control"></div>
                            </div>
                            <div class="form-group" style="margin-top:15px"><label style="color:var(--danger)">SƒêT Kh·∫©n c·∫•p (*)</label><input type="text" id="inp-sos" class="form-control"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modal-student')">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveStudentData()">L∆∞u H·ªì S∆°</button>
            </div>
        </div>
    </div>

    <div id="modal-fee" class="modal">
        <div class="modal-content" style="max-width:500px; height:auto">
            <div class="modal-header"><h3>C√†i ƒë·∫∑t kho·∫£n thu</h3><span onclick="document.getElementById('modal-fee').style.display='none'" style="cursor:pointer">&times;</span></div>
            <div class="modal-body">
                <div style="display:flex; gap:10px; margin-bottom:15px">
                    <input type="text" id="new-fee-name" class="form-control" placeholder="T√™n kho·∫£n thu">
                    <input type="number" id="new-fee-amt" class="form-control" placeholder="S·ªë ti·ªÅn" style="width:120px">
                    <button class="btn btn-success" onclick="addFee()">Th√™m</button>
                </div>
                <div id="fee-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, remove, update, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXeGmjCH_v6jnxEmBoQMpY7NP2fqrnLAQ",
            authDomain: "quan-ly-tieu-hoc.firebaseapp.com",
            databaseURL: "https://quan-ly-tieu-hoc-default-rtdb.firebaseio.com",
            projectId: "quan-ly-tieu-hoc",
            storageBucket: "quan-ly-tieu-hoc.firebasestorage.app",
            messagingSenderId: "525298263647",
            appId: "1:525298263647:web:767a5df6ac373323671dea"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let localData = { students: {}, feeConfig: {}, feeStatus: {} };

        // AUTH
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } catch(e){ Swal.fire('L·ªói','Sai th√¥ng tin','error'); } }
        window.handleLogout = () => signOut(auth);
        onAuthStateChanged(auth, (user) => {
            document.getElementById('auth-screen').classList.toggle('hidden', !!user);
            document.getElementById('app-container').classList.toggle('hidden', !user);
            if(user) {
                document.getElementById('user-info').innerText = user.email;
                onValue(ref(db, 'students'), (snap) => { localData.students = snap.val() || {}; renderStudentTable(); updateDashboard(); });
                onValue(ref(db, 'finance_config'), (snap) => { localData.feeConfig = snap.val() || {}; renderFeeList(); });
                onValue(ref(db, 'finance_status'), (snap) => { localData.feeStatus = snap.val() || {}; });
            }
        });

        // NAVIGATION
        window.nav = (tab) => {
            document.querySelectorAll('.view-section').forEach(el=>el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.menu-item').forEach(el=>el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('page-title').innerText = event.currentTarget.innerText;
            if(tab === 'finance') loadFinanceView();
        }
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // --- MODULE 1: H·ªåC SINH (CRUD, FILTER, DETAIL) ---
        
        window.renderStudentTable = () => {
            const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
            const key = document.getElementById('search-key').value.toLowerCase();
            const grade = document.getElementById('filter-grade').value;
            const status = document.getElementById('filter-status').value;
            
            let count = 0;
            Object.entries(localData.students).forEach(([id, s]) => {
                if(grade && !s.class.startsWith(grade)) return;
                if(status && s.status !== status) return;
                if(key && !s.name.toLowerCase().includes(key) && !s.code.toLowerCase().includes(key)) return;
                
                count++;
                const avatar = s.avatar || `https://ui-avatars.com/api/?name=${s.name}&background=random`;
                const badge = s.status==='active' ? '<span class="badge badge-success">ƒêang h·ªçc</span>' : (s.status==='reserved'?'<span class="badge badge-warning">B·∫£o l∆∞u</span>':'<span class="badge badge-danger">Ngh·ªâ</span>');
                const parent = s.dadName ? `${s.dadName} (B·ªë)` : (s.momName ? `${s.momName} (M·∫π)` : '---');
                const phone = s.sosPhone || s.dadPhone || s.momPhone || '';

                tbody.innerHTML += `
                    <tr>
                        <td><img src="${avatar}" class="avatar-sm"></td>
                        <td><b>${s.code}</b></td>
                        <td><a href="#" onclick="editStudent('${id}')" style="color:var(--primary);text-decoration:none;font-weight:600">${s.name}</a></td>
                        <td><span style="background:#e0f2fe;color:#0369a1;padding:2px 6px;border-radius:4px;font-weight:600">${s.class}</span></td>
                        <td>${s.dob || '-'}</td>
                        <td><div style="font-size:0.85rem;font-weight:500">${parent}</div><div style="font-size:0.8rem;color:#64748b">${phone}</div></td>
                        <td>${badge}</td>
                        <td style="text-align:right">
                            <button class="btn btn-outline" onclick="editStudent('${id}')"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-danger" onclick="delStudent('${id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            document.getElementById('count-display').innerText = `Hi·ªÉn th·ªã ${count} h·ªçc sinh`;
        }

        window.openStudentModal = () => {
            document.getElementById('modal-student').style.display='flex';
            document.getElementById('modal-title').innerText = 'Th√™m H·ªçc Sinh M·ªõi';
            // Clear form
            document.querySelectorAll('#modal-student input').forEach(i => i.value='');
            document.getElementById('inp-gender').value='Nam'; document.getElementById('inp-status').value='active';
            document.getElementById('inp-eth').value='Kinh'; document.getElementById('inp-rel').value='Kh√¥ng';
            document.getElementById('preview-img').style.display='none';
        }

        window.editStudent = (id) => {
            const s = localData.students[id]; if(!s) return;
            document.getElementById('modal-student').style.display='flex';
            document.getElementById('modal-title').innerText = 'Ch·ªânh S·ª≠a H·ªì S∆°';
            
            // Fill data
            document.getElementById('inp-id').value = id;
            document.getElementById('inp-code').value=s.code; document.getElementById('inp-name').value=s.name;
            document.getElementById('inp-class').value=s.class; document.getElementById('inp-gender').value=s.gender;
            document.getElementById('inp-dob').value=s.dob||''; document.getElementById('inp-status').value=s.status||'active';
            document.getElementById('inp-eth').value=s.ethnicity||'Kinh'; document.getElementById('inp-rel').value=s.religion||'Kh√¥ng';
            document.getElementById('inp-addr').value=s.address||'';
            document.getElementById('inp-dad').value=s.dadName||''; document.getElementById('inp-dad-job').value=s.dadJob||''; document.getElementById('inp-dad-phone').value=s.dadPhone||'';
            document.getElementById('inp-mom').value=s.momName||''; document.getElementById('inp-mom-job').value=s.momJob||''; document.getElementById('inp-mom-phone').value=s.momPhone||'';
            document.getElementById('inp-sos').value=s.sosPhone||'';
            
            if(s.avatar) { document.getElementById('preview-img').src=s.avatar; document.getElementById('preview-img').style.display='block'; document.getElementById('inp-avatar-base64').value=s.avatar; }
            else { document.getElementById('preview-img').style.display='none'; }
        }

        window.handleAvatarPreview = (inp) => {
            if(inp.files && inp.files[0]) {
                if(inp.files[0].size > 500000) { Swal.fire('L·ªói','·∫¢nh qu√° l·ªõn (<500KB)','warning'); inp.value=''; return; }
                const r = new FileReader();
                r.onload = (e) => { document.getElementById('preview-img').src=e.target.result; document.getElementById('preview-img').style.display='block'; document.getElementById('inp-avatar-base64').value=e.target.result; };
                r.readAsDataURL(inp.files[0]);
            }
        }

        window.saveStudentData = () => {
            const id = document.getElementById('inp-id').value;
            const name = document.getElementById('inp-name').value;
            const cls = document.getElementById('inp-class').value.toUpperCase();
            if(!name || !cls) return Swal.fire('L·ªói','T√™n v√† L·ªõp l√† b·∫Øt bu·ªôc','warning');

            const data = {
                code: document.getElementById('inp-code').value || 'HS'+Date.now().toString().slice(-5),
                name: name, class: cls, gender: document.getElementById('inp-gender').value,
                dob: document.getElementById('inp-dob').value, status: document.getElementById('inp-status').value,
                ethnicity: document.getElementById('inp-eth').value, religion: document.getElementById('inp-rel').value, address: document.getElementById('inp-addr').value,
                dadName: document.getElementById('inp-dad').value, dadJob: document.getElementById('inp-dad-job').value, dadPhone: document.getElementById('inp-dad-phone').value,
                momName: document.getElementById('inp-mom').value, momJob: document.getElementById('inp-mom-job').value, momPhone: document.getElementById('inp-mom-phone').value,
                sosPhone: document.getElementById('inp-sos').value, avatar: document.getElementById('inp-avatar-base64').value, createdAt: Date.now()
            };

            if(id) update(ref(db, `students/${id}`), data).then(()=>{ closeModal('modal-student'); Swal.fire('Th√†nh c√¥ng','ƒê√£ c·∫≠p nh·∫≠t','success'); });
            else push(ref(db, 'students'), data).then(()=>{ closeModal('modal-student'); Swal.fire('Th√†nh c√¥ng','ƒê√£ th√™m m·ªõi','success'); });
        }
        window.delStudent = (id) => { if(confirm('Ch·∫Øc ch·∫Øn x√≥a?')) remove(ref(db, `students/${id}`)); }

        // EXCEL IMPORT/EXPORT
        // --- H√ÄM NH·∫¨P EXCEL M·ªöI (C√ì B√ÅO L·ªñI) ---
        // --- H√ÄM NH·∫¨P EXCEL (ƒê√É S·ª¨A L·ªñI NG√ÄY SINH) ---
        window.importExcel = (inp) => {
            const f = inp.files[0]; 
            if(!f) return;
            inp.value = ''; 

            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // --- S·ª¨A L·ªñI NG√ÄY SINH T·∫†I ƒê√ÇY ---
                    // raw: false -> √âp l·∫•y d·ªØ li·ªáu hi·ªÉn th·ªã (text) thay v√¨ s·ªë ng·∫ßm ƒë·ªãnh
                    // dateNF: 'dd/mm/yyyy' -> √âp ƒë·ªãnh d·∫°ng ng√†y th√°ng nƒÉm
                    const json = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false, 
                        dateNF: 'dd/mm/yyyy',
                        defval: ""
                    });

                    if (json.length === 0) {
                        return Swal.fire('L·ªói', 'File Excel tr·ªëng ho·∫∑c l·ªói ti√™u ƒë·ªÅ.', 'error');
                    }

                    let count = 0;
                    json.forEach(row => {
                        // Ki·ªÉm tra xem d√≤ng n√†y c√≥ t√™n h·ªçc sinh kh√¥ng
                        if (!row['H·ªç T√™n'] && !row['H·ªç v√† T√™n']) return; 

                        const studentData = {
                            code: row['M√£ HS'] || 'HS' + Math.floor(Math.random() * 99999),
                            name: row['H·ªç T√™n'] || row['H·ªç v√† T√™n'], 
                            class: row['L·ªõp'] ? row['L·ªõp'].toString().toUpperCase() : '?',
                            gender: row['Gi·ªõi t√≠nh'] || 'Nam',
                            
                            // L·∫•y ng√†y sinh (n·∫øu Excel ƒë·ªÉ tr·ªëng th√¨ ƒë·ªÉ chu·ªói r·ªóng)
                            dob: row['Ng√†y sinh'] || '',
                            
                            status: 'active',
                            address: row['ƒê·ªãa ch·ªâ'] || '',
                            ethnicity: row['D√¢n t·ªôc'] || 'Kinh',
                            religion: row['T√¥n gi√°o'] || 'Kh√¥ng',
                            dadName: row['H·ªç t√™n Cha'] || '',
                            dadJob: row['Ngh·ªÅ Cha'] || '',
                            dadPhone: row['SƒêT Cha'] || '',
                            momName: row['H·ªç t√™n M·∫π'] || '',
                            momJob: row['Ngh·ªÅ M·∫π'] || '',
                            momPhone: row['SƒêT M·∫π'] || '',
                            sosPhone: row['SƒêT Kh·∫©n c·∫•p'] || row['SƒêT Cha'] || '',
                            createdAt: Date.now()
                        };
                        
                        push(ref(db, 'students'), studentData);
                        count++;
                    });

                    Swal.fire({
                        title: 'Th√†nh c√¥ng!',
                        text: `ƒê√£ nh·∫≠p ${count} h·ªçc sinh. Ng√†y sinh ƒë√£ hi·ªÉn th·ªã ƒë√∫ng!`,
                        icon: 'success'
                    });

                } catch (error) {
                    console.error(error);
                    Swal.fire('L·ªói file', 'Vui l√≤ng ki·ªÉm tra l·∫°i file Excel.', 'error');
                }
            };
            r.readAsArrayBuffer(f);
        }
        // --- H√ÄM T·∫†O FILE M·∫™U CHU·∫®N ---
        window.downloadTemplate = () => {
            const data = [
                {
                    "M√£ HS": "HS001", "H·ªç T√™n": "Nguy·ªÖn VƒÉn A", "L·ªõp": "1A", "Gi·ªõi t√≠nh": "Nam", "Ng√†y sinh": "15/01/2017",
                    "D√¢n t·ªôc": "Kinh", "T√¥n gi√°o": "Kh√¥ng", "ƒê·ªãa ch·ªâ": "123 ƒê∆∞·ªùng ABC",
                    "H·ªç t√™n Cha": "Nguy·ªÖn VƒÉn B", "Ngh·ªÅ Cha": "C√¥ng nh√¢n", "SƒêT Cha": "0912345678",
                    "H·ªç t√™n M·∫π": "L√™ Th·ªã C", "Ngh·ªÅ M·∫π": "Gi√°o vi√™n", "SƒêT M·∫π": "0987654321", "SƒêT Kh·∫©n c·∫•p": "0912345678"
                },
                {
                    "M√£ HS": "HS002", "H·ªç T√™n": "Tr·∫ßn Th·ªã B", "L·ªõp": "1A", "Gi·ªõi t√≠nh": "N·ªØ", "Ng√†y sinh": "20/02/2017",
                    "D√¢n t·ªôc": "Kinh", "T√¥n gi√°o": "Ph·∫≠t", "ƒê·ªãa ch·ªâ": "456 ƒê∆∞·ªùng XYZ",
                    "H·ªç t√™n Cha": "", "Ngh·ªÅ Cha": "", "SƒêT Cha": "",
                    "H·ªç t√™n M·∫π": "", "Ngh·ªÅ M·∫π": "", "SƒêT M·∫π": "", "SƒêT Kh·∫©n c·∫•p": "0999888777"
                }
            ];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Ch·ªânh ƒë·ªô r·ªông c·ªôt cho d·ªÖ nh√¨n
            ws['!cols'] = [{wch:10}, {wch:20}, {wch:5}, {wch:8}, {wch:12}, {wch:8}, {wch:10}, {wch:20}, {wch:15}, {wch:10}, {wch:12}, {wch:15}, {wch:10}, {wch:12}, {wch:12}];
            
            XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
            XLSX.writeFile(wb, "File_Mau_Nhap_Hoc_Sinh.xlsx");
        }
        
        window.exportStudentExcel = () => {
            const data = [];
            const gr = document.getElementById('filter-grade').value, st = document.getElementById('filter-status').value;
            Object.values(localData.students).forEach(s => {
                if(gr && !s.class.startsWith(gr)) return; if(st && s.status!==st) return;
                data.push({ "M√£ HS":s.code, "H·ªç T√™n":s.name, "L·ªõp":s.class, "Gi·ªõi t√≠nh":s.gender, "Ng√†y sinh":s.dob, "Tr·∫°ng th√°i":s.status, "SƒêT Kh·∫©n c·∫•p":s.sosPhone, "Cha":s.dadName, "SƒêT Cha":s.dadPhone, "M·∫π":s.momName, "SƒêT M·∫π":s.momPhone });
            });
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "DS_HocSinh");
            XLSX.writeFile(wb, "DanhSachHocSinh.xlsx");
        }

        // --- MODULE 2: ƒêI·ªÇM (GI·ªÆ NGUY√äN) ---
        const SUBS = { 'tiengviet':'Ti·∫øng Vi·ªát', 'toan':'To√°n', 'ngoaingu1':'NN1', 'daoduc':'ƒê·∫°o ƒë·ª©c', 'tnxh':'TNXH', 'lsdl':'LS&ƒêL', 'khoahoc':'Khoa h·ªçc', 'tinhoc':'Tin h·ªçc', 'thechat':'Th·ªÉ ch·∫•t', 'nghethuat':'Ngh·ªá thu·∫≠t', 'hdtrainghiem':'HƒêTN' };
        window.loadClassGrades = async () => {
            const c = document.getElementById('acad-grade').value + document.getElementById('acad-class').value.toUpperCase();
            const s = document.getElementById('acad-subject').value;
            if(c.length<2) return Swal.fire('L·ªói','Nh·∫≠p t√™n l·ªõp','warning');
            let g = {}; try{const sn=await get(child(ref(db),`grades/${c}/${s}`)); if(sn.exists())g=sn.val();}catch(e){}
            const stus = Object.entries(localData.students).filter(([k,v])=>v.class===c);
            const tb = document.getElementById('table-grades-body'); tb.innerHTML='';
            stus.forEach(([k,v])=>{
                const d = g[k]||{};
                tb.innerHTML += `<tr data-id="${k}"><td><b>${v.name}</b></td>
                <td><input class="inp-mini gk1" value="${d.gk1||''}" oninput="calc(this)"></td><td><input class="inp-mini ck1" value="${d.ck1||''}" oninput="calc(this)"></td><td class="col-calc tb1">-</td>
                <td><input class="inp-mini gk2" value="${d.gk2||''}" oninput="calc(this)"></td><td><input class="inp-mini ck2" value="${d.ck2||''}" oninput="calc(this)"></td><td class="col-calc tb2">-</td>
                <td class="col-calc year">-</td><td class="col-calc rank" style="font-weight:normal">-</td><td><input value="${d.nx||''}" class="inp-nx" style="width:100%"></td></tr>`;
            });
            document.querySelectorAll('#table-grades-body tr').forEach(r=>calc(r.querySelector('input')));
        }
        window.calc = (el) => {
            if(!el)return; const tr=el.closest('tr'); const v=(s)=>{const x=tr.querySelector(s).value; return x===''?null:parseFloat(x)};
            const t1=(v('.gk1')!==null&&v('.ck1')!==null)?(v('.gk1')+v('.ck1')*2)/3:null;
            const t2=(v('.gk2')!==null&&v('.ck2')!==null)?(v('.gk2')+v('.ck2')*2)/3:null;
            tr.querySelector('.tb1').innerText=t1?t1.toFixed(1):'-'; tr.querySelector('.tb2').innerText=t2?t2.toFixed(1):'-';
            if(t1!==null&&t2!==null){const cn=(t1+t2*2)/3; tr.querySelector('.year').innerText=cn.toFixed(1); tr.querySelector('.rank').innerText=cn>=9?'HTT':(cn>=7?'T·ªët':(cn>=5?'HT':'CHT'));}
        }
        window.saveCurrentSubject = async () => {
            const c = document.getElementById('acad-grade').value + document.getElementById('acad-class').value.toUpperCase();
            const s = document.getElementById('acad-subject').value;
            const u={}; document.querySelectorAll('#table-grades-body tr').forEach(r=>{
                u[r.getAttribute('data-id')]={gk1:r.querySelector('.gk1').value,ck1:r.querySelector('.ck1').value,gk2:r.querySelector('.gk2').value,ck2:r.querySelector('.ck2').value,nx:r.querySelector('.inp-nx').value};
            });
            await set(ref(db,`grades/${c}/${s}`), u); Swal.fire('OK','ƒê√£ l∆∞u','success');
        }
        // --- C·∫¨P NH·∫¨T H√ÄM XU·∫§T EXCEL TH√îNG MINH ---
        window.exportMasterExcel = async () => {
            // 1. L·∫•y th√¥ng tin l·ªõp
            const grade = document.getElementById('acad-grade').value;
            const className = document.getElementById('acad-class').value.toUpperCase().trim();
            const fullClass = grade + className;

            if (className.length === 0) return Swal.fire('L·ªói', 'Vui l√≤ng nh·∫≠p t√™n l·ªõp (VD: A, B)', 'warning');

            // 2. Hi·ªÉn th·ªã th√¥ng b√°o ƒëang t·∫£i
            Swal.fire({
                title: 'ƒêang t·ªïng h·ª£p d·ªØ li·ªáu...',
                text: `ƒêang l·∫•y b·∫£ng ƒëi·ªÉm c·ªßa l·ªõp ${fullClass} t·ª´ h·ªá th·ªëng...`,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // 3. L·ªçc danh s√°ch h·ªçc sinh c·ªßa l·ªõp n√†y
            const studentsInClass = Object.entries(localData.students)
                .filter(([key, s]) => s.class === fullClass)
                .map(([key, s]) => ({ ...s, key })); // Gi·ªØ l·∫°i Key Firebase ƒë·ªÉ kh·ªõp ƒëi·ªÉm

            if (studentsInClass.length === 0) {
                return Swal.fire('L·ªói', `L·ªõp ${fullClass} ch∆∞a c√≥ h·ªçc sinh n√†o trong danh s√°ch h·ªì s∆°!`, 'error');
            }

            // 4. L·∫•y to√†n b·ªô ƒëi·ªÉm c·ªßa l·ªõp n√†y t·ª´ Firebase
            let allGrades = {}; 
            try { 
                const snap = await get(child(ref(db), `grades/${fullClass}`)); 
                if (snap.exists()) allGrades = snap.val(); 
            } catch(e) { console.error(e); }

            // Ki·ªÉm tra xem c√≥ ƒëi·ªÉm ch∆∞a (ƒë·ªÉ c·∫£nh b√°o)
            const hasData = Object.keys(allGrades).length > 0;
            if (!hasData) {
                // V·∫´n cho xu·∫•t nh∆∞ng c·∫£nh b√°o
                Swal.fire({
                    title: 'C·∫£nh b√°o',
                    text: 'L·ªõp n√†y ch∆∞a ƒë∆∞·ª£c L∆ØU ƒëi·ªÉm m√¥n n√†o tr√™n h·ªá th·ªëng. File Excel s·∫Ω ch·ªâ c√≥ t√™n h·ªçc sinh.',
                    icon: 'warning',
                    timer: 3000
                });
            }

            // 5. Chu·∫©n b·ªã d·ªØ li·ªáu cho 3 Sheet
            const dataHK1 = [], dataHK2 = [], dataCN = [];

            studentsInClass.forEach(s => {
                // Khung s∆∞·ªùn cho t·ª´ng d√≤ng
                let row1 = { "M√£ HS": s.code, "H·ªç T√™n": s.name, "Ng√†y sinh": s.dob };
                let row2 = { "M√£ HS": s.code, "H·ªç T√™n": s.name, "Ng√†y sinh": s.dob };
                let row3 = { "M√£ HS": s.code, "H·ªç T√™n": s.name, "Ng√†y sinh": s.dob };
                let nhanXetList = [];

                // Duy·ªát qua t·ª´ng m√¥n h·ªçc ƒë·ªÉ l·∫•y ƒëi·ªÉm
                Object.entries(SUBS).forEach(([subjId, subjName]) => {
                    // L·∫•y ƒëi·ªÉm c·ªßa h·ªçc sinh n√†y (s.key) trong m√¥n n√†y (subjId)
                    // C·∫•u tr√∫c: allGrades[mon_hoc][id_hoc_sinh]
                    const g = (allGrades[subjId] && allGrades[subjId][s.key]) ? allGrades[subjId][s.key] : {};

                    // Helper t√≠nh ƒëi·ªÉm: N·∫øu c√≥ ƒëi·ªÉm th√¨ parse s·ªë, kh√¥ng th√¨ ƒë·ªÉ tr·ªëng
                    const getVal = (val) => (val && val !== '') ? parseFloat(val) : null;

                    const gk1 = getVal(g.gk1);
                    const ck1 = getVal(g.ck1);
                    const gk2 = getVal(g.gk2);
                    const ck2 = getVal(g.ck2);

                    // T√≠nh Trung B√¨nh
                    let tb1 = null, tb2 = null, cn = null;

                    if (gk1 !== null && ck1 !== null) tb1 = (gk1 + ck1 * 2) / 3;
                    if (gk2 !== null && ck2 !== null) tb2 = (gk2 + ck2 * 2) / 3;
                    if (tb1 !== null && tb2 !== null) cn = (tb1 + tb2 * 2) / 3;

                    // G√°n v√†o d√≤ng (L√†m tr√≤n 1 s·ªë th·∫≠p ph√¢n)
                    row1[subjName] = tb1 !== null ? tb1.toFixed(1) : '';
                    row2[subjName] = tb2 !== null ? tb2.toFixed(1) : '';
                    row3[subjName] = cn !== null ? cn.toFixed(1) : '';

                    // Gom nh·∫≠n x√©t
                    if (g.nx && g.nx.trim() !== '') {
                        nhanXetList.push(`[${subjName}]: ${g.nx}`);
                    }
                });

                // G√°n c·ªôt nh·∫≠n x√©t t·ªïng h·ª£p
                const nxString = nhanXetList.join('; ');
                row1['Nh·∫≠n x√©t chung'] = nxString;
                row2['Nh·∫≠n x√©t chung'] = nxString;
                row3['Nh·∫≠n x√©t chung'] = nxString;

                dataHK1.push(row1);
                dataHK2.push(row2);
                dataCN.push(row3);
            });

            // 6. T·∫°o File Excel
            const wb = XLSX.utils.book_new();
            
            // H√†m t·∫°o sheet v·ªõi ƒë·ªô r·ªông c·ªôt ƒë·∫πp
            const appendSheet = (data, name) => {
                const ws = XLSX.utils.json_to_sheet(data);
                const wscols = [{wch:10}, {wch:25}, {wch:12}]; // M√£, T√™n, Ng√†y sinh
                Object.keys(SUBS).forEach(() => wscols.push({wch:8})); // C√°c c·ªôt ƒëi·ªÉm
                wscols.push({wch:50}); // C·ªôt nh·∫≠n x√©t
                ws['!cols'] = wscols;
                XLSX.utils.book_append_sheet(wb, ws, name);
            }

            appendSheet(dataHK1, "HocKy1");
            appendSheet(dataHK2, "HocKy2");
            appendSheet(dataCN, "CaNam");

            XLSX.writeFile(wb, `BangDiem_TongHop_Lop${fullClass}.xlsx`);
            
            Swal.close(); // T·∫Øt loading
        }

        // --- MODULE 3: T√ÄI CH√çNH (GI·ªÆ NGUY√äN) ---
        window.addFee = () => {
            const n=document.getElementById('new-fee-name').value, a=document.getElementById('new-fee-amt').value;
            if(n&&a) push(ref(db,'finance_config'),{name:n,amount:a});
        }
        window.loadFinanceView = () => {
            const g = document.getElementById('fin-grade').value, c = document.getElementById('fin-class').value.toUpperCase();
            let stus = Object.entries(localData.students);
            if(g||c) stus=stus.filter(([k,v]) => (!g||v.class.startsWith(g)) && (!c||v.class===c));
            
            const th = document.getElementById('fin-thead'); th.innerHTML=`<tr><th>H·ªçc sinh</th>${Object.values(localData.feeConfig).map(f=>`<th>${f.name}<br><small>${parseInt(f.amount).toLocaleString()}</small></th>`).join('')}<th>ƒê√£ n·ªôp</th></tr>`;
            const tb = document.getElementById('fin-tbody'); tb.innerHTML='';
            let exp=0, col=0;
            stus.forEach(([k,s])=>{
                let pd=0;
                const cells = Object.entries(localData.feeConfig).map(([fid,f])=>{
                    exp+=parseInt(f.amount);
                    const paid = localData.feeStatus[k]&&localData.feeStatus[k][fid];
                    if(paid) { col+=parseInt(f.amount); pd+=parseInt(f.amount); return `<td style="text-align:center"><span class="badge badge-success" onclick="toggleFee('${k}','${fid}',false)">ƒê√£ thu</span></td>`; }
                    return `<td style="text-align:center"><span class="badge badge-warning" style="cursor:pointer" onclick="toggleFee('${k}','${fid}',true)">Ch∆∞a</span></td>`;
                }).join('');
                tb.innerHTML += `<tr><td><b>${s.name}</b><br><small>${s.class}</small></td>${cells}<td style="text-align:right;font-weight:bold">${pd.toLocaleString()}</td></tr>`;
            });
            document.getElementById('fin-expect').innerText=exp.toLocaleString()+' ƒë'; document.getElementById('fin-collected').innerText=col.toLocaleString()+' ƒë'; document.getElementById('fin-remain').innerText=(exp-col).toLocaleString()+' ƒë';
        }
        // --- S·ª¨A L·ªñI: B·∫§M L√Ä NH·∫¢Y S·ªê LI·ªÄN (KH√îNG C·∫¶N RESET) ---
        window.toggleFee = (k, f, v) => {
            // 1. C·∫≠p nh·∫≠t ngay v√†o d·ªØ li·ªáu t·∫°m tr√™n m√°y (ƒë·ªÉ ƒë·ªïi m√†u li·ªÅn)
            if (!localData.feeStatus[k]) localData.feeStatus[k] = {};
            localData.feeStatus[k][f] = v;

            // 2. G·ª≠i d·ªØ li·ªáu l√™n Firebase (ch·∫°y ng·∫ßm)
            update(ref(db, `finance_status/${k}`), {[f]: v});

            // 3. Quan tr·ªçng nh·∫•t: G·ªçi h√†m v·∫Ω l·∫°i b·∫£ng ngay l·∫≠p t·ª©c
            loadFinanceView();
        }
        window.delFee = (k) => remove(ref(db,`finance_config/${k}`));

        // DASHBOARD
        function updateDashboard(){
            const s = Object.values(localData.students);
            document.getElementById('dash-total').innerText = s.length;
            document.getElementById('dash-new').innerText = s.filter(x=>(Date.now()-x.createdAt)<2592000000).length;
            const nam = s.filter(x=>x.gender==='Nam').length, nu = s.filter(x=>x.gender==='N·ªØ').length;
            document.getElementById('dash-male').innerText = nam; document.getElementById('dash-female').innerText = nu;
            if(window.chart) window.chart.destroy();
            window.chart = new Chart(document.getElementById('genderChart'), {type:'doughnut',data:{labels:['Nam','N·ªØ'],datasets:[{data:[nam,nu],backgroundColor:['#3b82f6','#ec4899']}]}});
        }
    </script>
</body>
</html>
